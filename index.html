<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Coin Flipper</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent double-tap-to-zoom on all interactive elements for fast consecutive taps */
        button,
        input,
        select,
        textarea,
        a,
        [role="button"],
        .btn,
        .settings-switch,
        .toggle-btn,
        .close-btn,
        .okaun-btn,
        .okaun-icon-btn,
        .confirm-btn,
        .flip-btn-container,
        .undo-flip-btn,
        .coins-control,
        .voltron-control,
        .ench-control,
        .ench-btn,
        .card-btn,
        .settings-panel-title,
        .ench-settings-title {
            touch-action: manipulation;
        }

        :root {
            --bg-gradient: linear-gradient(180deg, 
                #2d5a27 0%, 
                #4a7c23 10%,
                #8fb832 20%,
                #c4c426 30%,
                #e8a525 40%,
                #e07028 50%,
                #d4527a 65%,
                #a94d99 80%,
                #6b4d8a 100%
            );
            --bg-power-save: #2a2a2a;
            --panel-dark: #1a1a1a;
            --panel-gray: #4a4a4a;
            --panel-light: #6a6a6a;
            --text-white: #ffffff;
            --accent-red: #cc0000;
            --accent-red-hover: #a62942;
            --okaun-red: rgba(255, 0, 51, 1);
            --win-green: #22c55e;
            --loss-red: #ef4444;
            --toggle-active: #ffffff;
            --overlay-bg: rgba(0, 0, 0, 0.85);
            --help-blue: #3b82f6;
            
            --gold-light: #ffd700;
            --gold-mid: #daa520;
            --gold-dark: #b8860b;
            --gold-shine: #fff8dc;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            transition: background 0.3s ease;
        }

        body.power-save,
        body.simple-mode {
            background: var(--bg-power-save);
        }

        body.simple-mode *,
        body.simple-mode *::before,
        body.simple-mode *::after {
            animation: none !important;
            transition: none !important;
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100%;
            max-height: 850px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .result-panel {
            background: var(--panel-dark);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 120px;
            position: relative;
            transition: all 0.3s ease;
        }

        .result-panel.expanded {
            flex: 1;
            max-height: 280px;
        }

        .result-display {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(2.5rem, 10vw, 4rem);
            color: var(--text-white);
            letter-spacing: 2px;
            transition: color 0.3s ease;
        }

        .result-display.win {
            color: var(--win-green);
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
        }

        .result-display.loss {
            color: var(--loss-red);
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .history-bar {
            background: #0a0a0a;
            border-radius: 8px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            gap: 8px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .history-bar::-webkit-scrollbar {
            display: none;
        }

        .history-item {
            flex-shrink: 0;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            border-radius: 4px;
            padding: 0 4px;
        }

        .history-item.win {
            color: var(--win-green);
        }

        .history-item.loss {
            color: var(--loss-red);
        }

        .history-item.fraction {
            background: rgba(255,255,255,0.1);
        }

        .history-item.fraction.win {
            color: var(--win-green);
        }

        .history-item.fraction.loss {
            color: var(--loss-red);
        }

        .history-item.latest {
            background: linear-gradient(145deg, 
                var(--gold-light) 0%, 
                var(--gold-mid) 25%, 
                var(--gold-dark) 50%, 
                var(--gold-mid) 75%, 
                var(--gold-light) 100%
            );
            font-weight: 800;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(218, 165, 32, 0.4);
        }

        .history-item.latest.win {
            color: #166534;
        }

        .history-item.latest.loss {
            color: #991b1b;
        }

        .history-item.latest::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -100%;
            width: 60%;
            height: 200%;
            background: linear-gradient(
                90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0) 20%,
                rgba(255, 255, 255, 0.4) 40%,
                rgba(255, 255, 255, 0.8) 50%,
                rgba(255, 255, 255, 0.4) 60%,
                rgba(255, 255, 255, 0) 80%,
                transparent 100%
            );
            transform: skewX(-25deg);
            animation: shimmer 3s infinite;
        }

        .history-item.latest.sparkle {
            animation: sparkleIn 0.4s ease-out;
        }

        @keyframes sparkleIn {
            0% { 
                transform: scale(0.5); 
                opacity: 0;
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            50% { 
                transform: scale(1.3);
                box-shadow: 0 0 30px rgba(255, 215, 0, 1);
            }
            100% { 
                transform: scale(1); 
                opacity: 1;
                box-shadow: 0 2px 8px rgba(218, 165, 32, 0.4);
            }
        }

        .okaun-panel {
            background: var(--panel-dark);
            border-radius: 16px;
            padding: 12px;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .okaun-panel.collapsed {
            padding: 0;
            background: transparent;
        }

        .okaun-content {
            max-height: 500px;
            opacity: 1;
            transition: all 0.3s ease;
            overflow: hidden;
            margin-top: 8px;
            position: relative;
        }

        .okaun-panel.collapsed .okaun-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .okaun-panel.collapsed .okaun-toggle-btn {
            width: 100%;
            border-radius: 12px;
            margin: 0;
        }

        .okaun-panel:not(.collapsed) > .okaun-toggle-btn {
            display: none;
        }

        .okaun-collapse-btn {
            flex: 1;
            background: #8cdb51;
            border: none;
            border-radius: 20px;
            padding: 10px 8px;
            font-family: 'Outfit', sans-serif;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .okaun-collapse-btn:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .okaun-collapse-btn:active {
            transform: scale(0.98);
        }

        .okaun-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            position: relative;
        }

        .okaun-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.2rem, 5vw, 1.6rem);
            color: var(--text-white);
            text-align: center;
            letter-spacing: 3px;
        }

        .okaun-icons {
            position: absolute;
            right: 0;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .okaun-icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
            position: relative;
        }

        .okaun-icon-btn:hover {
            opacity: 1;
        }

        .okaun-icon-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--text-white);
        }

        .okaun-icon-btn.speaking svg {
            fill: var(--win-green);
        }

        .okaun-values {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 0 4px;
        }

        .okaun-input-wrapper {
            flex: 0 0 auto;
            width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .okaun-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .okaun-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 28px;
            height: 20px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }

        .okaun-arrow:hover {
            background: var(--panel-gray);
        }

        .okaun-panel.collapsed .okaun-arrows {
            display: none;
        }

        /* Okaun Options Button */
        .okaun-options-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s;
            font-size: 18px;
            color: var(--text-white);
            letter-spacing: 2px;
        }

        .okaun-options-btn:hover {
            opacity: 1;
        }

        /* Okaun Options Modal */
        .okaun-options-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1200;
            justify-content: center;
            align-items: center;
        }

        .okaun-options-modal.visible {
            display: flex;
        }

        .okaun-options-content {
            background: var(--panel-dark);
            border-radius: 16px;
            padding: 20px;
            min-width: 280px;
            max-width: 320px;
            position: relative;
        }

        .okaun-options-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            color: var(--text-white);
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: 2px;
        }

        .okaun-options-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .okaun-options-row:last-child {
            border-bottom: none;
        }

        .okaun-options-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .okaun-options-counter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .okaun-options-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.3rem;
            color: var(--text-white);
            min-width: 30px;
            text-align: center;
        }

        .okaun-options-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .okaun-options-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 28px;
            height: 20px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }

        .okaun-options-arrow:hover {
            background: var(--panel-gray);
        }

        .okaun-options-btn-row {
            margin-top: 8px;
        }

        .okaun-options-action {
            width: 100%;
            background: var(--panel-gray);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .okaun-options-action:hover {
            background: var(--panel-light);
        }

        .okaun-options-action.danger {
            background: var(--accent-red);
        }

        .okaun-options-action.danger:hover {
            background: var(--accent-red-hover);
        }

        .okaun-options-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--panel-gray);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .okaun-options-switch.active {
            background: var(--win-green);
        }

        .okaun-options-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .okaun-options-switch.active::after {
            transform: translateX(24px);
        }

        .okaun-plusx-inputs {
            display: none;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            padding-left: 16px;
        }

        .okaun-plusx-inputs.visible {
            display: flex;
        }

        .okaun-plusx-label {
            font-size: 0.85rem;
            color: var(--text-white);
            opacity: 0.8;
        }

        .okaun-plusx-counter {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .okaun-plusx-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: var(--text-white);
            min-width: 20px;
            text-align: center;
        }

        .okaun-plusx-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .okaun-plusx-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 28px;
            height: 20px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }

        .okaun-plusx-arrow:hover {
            background: var(--panel-gray);
        }

        /* Okaun Carousel Navigation */
        .okaun-carousel-container {
            position: relative;
            overflow: hidden;
        }

        .okaun-carousel-track {
            display: flex;
            transition: transform 0.3s ease;
        }

        .okaun-slide {
            min-width: 100%;
            flex-shrink: 0;
            padding: 0 24px;
        }

        .okaun-nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            background: var(--panel-gray);
            border: none;
            color: var(--text-white);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
            z-index: 20;
        }

        .okaun-nav-arrow:hover {
            background: var(--panel-light);
        }

        .okaun-nav-arrow.left {
            left: 0;
            border-radius: 0 8px 8px 0;
        }

        .okaun-nav-arrow.right {
            right: 0;
            border-radius: 8px 0 0 8px;
        }

        .okaun-nav-arrow.visible {
            display: flex;
        }

        .okaun-number-indicator {
            display: none;
            position: absolute;
            left: 0;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.2rem, 5vw, 1.6rem);
            color: var(--text-white);
            opacity: 0.5;
            letter-spacing: 3px;
            text-align: left;
        }

        .okaun-number-indicator.visible {
            display: block;
        }

        /* Confirmation Modal */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1300;
            justify-content: center;
            align-items: center;
        }

        .confirm-modal.visible {
            display: flex;
        }

        .confirm-content {
            background: var(--panel-dark);
            border-radius: 16px;
            padding: 24px;
            max-width: 300px;
            text-align: center;
        }

        .confirm-text {
            color: var(--text-white);
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .confirm-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .confirm-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .confirm-btn.primary {
            background: var(--accent-red);
            color: var(--text-white);
        }

        .confirm-btn.primary:hover {
            background: var(--accent-red-hover);
        }

        .confirm-btn.secondary {
            background: var(--panel-gray);
            color: var(--text-white);
        }

        .confirm-btn.secondary:hover {
            background: var(--panel-light);
        }

        .confirm-btn.small-text {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .okaun-input {
            width: 85px;
            height: 70px;
            min-width: 85px;
            max-width: 85px;
            min-height: 70px;
            max-height: 70px;
            background: var(--panel-gray);
            border: none;
            border-radius: 12px;
            padding: 8px;
            font-family: 'Bebas Neue', sans-serif;
            color: var(--text-white);
            text-align: center;
            outline: none;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: text;
            overflow: hidden;
            box-sizing: border-box;
        }

        .okaun-input:focus {
            background: var(--panel-light);
        }

        .okaun-divider {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--text-white);
            opacity: 0.8;
            flex-shrink: 0;
        }

        .okaun-buttons {
            display: flex;
            gap: 8px;
        }

        .okaun-btn {
            flex: 1;
            background: var(--accent-red);
            border: none;
            border-radius: 20px;
            padding: 10px 8px;
            font-family: 'Outfit', sans-serif;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .okaun-btn:hover {
            background: var(--accent-red-hover);
            transform: scale(1.02);
        }

        .okaun-btn:active {
            transform: scale(0.98);
        }

        .okaun-btn.okaun-toggle-btn {
            background: #cc2936;
            transition: all 0.3s ease;
        }

        .okaun-btn.okaun-toggle-btn:hover {
            filter: brightness(1.1);
        }

        .okaun-btn.okaun-toggle-btn.active {
            background: #8cdb51;
        }

        .okaun-panel.collapsed .okaun-btn.okaun-toggle-btn {
            padding: 14px;
            font-size: clamp(1rem, 4vw, 1.2rem);
        }

        .krark-toggle {
            background: var(--panel-dark);
            border-radius: 12px;
            padding: 12px 16px;
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .krark-toggle.active {
            background: var(--toggle-active);
        }

        .krark-text {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.2rem, 5vw, 1.5rem);
            color: var(--text-white);
            letter-spacing: 1px;
            transition: all 0.3s;
            text-align: center;
        }

        .krark-toggle.active .krark-text {
            color: #000;
        }

        .krark-counter {
            display: none;
            align-items: center;
            gap: 8px;
            position: absolute;
            right: 12px;
        }

        .krark-toggle.active .krark-counter {
            display: flex;
        }

        .krark-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: #000;
            min-width: 20px;
            text-align: center;
        }

        .krark-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .krark-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 28px;
            height: 20px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }

        .krark-arrow:hover {
            background: var(--panel-gray);
        }

        .krark-num.flash-red {
            animation: flashRed 0.3s ease;
        }

        @keyframes flashRed {
            0%, 100% { color: #000; }
            50% { color: var(--loss-red); }
        }

        .main-controls {
            display: flex;
            gap: 8px;
            flex: 1;
            min-height: 180px;
            transition: all 0.3s ease;
        }


        .flip-btn-container {
            flex: 1;
            display: flex;
            position: relative;
        }

        .undo-flip-btn {
            position: absolute;
            bottom: 25%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-dark);
            border: none;
            border-radius: 14px;
            padding: 8px 24px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.3);
            cursor: default;
            transition: all 0.2s;
            z-index: 10;
        }

        .undo-flip-btn.has-undo {
            color: var(--text-white);
            cursor: pointer;
        }

        .undo-flip-btn.has-undo:hover {
            transform: translateX(-50%) scale(1.02);
            background: var(--panel-gray);
        }

        .flip-btn {
            width: 100%;
            background: linear-gradient(145deg, 
                var(--gold-light) 0%, 
                var(--gold-mid) 25%, 
                var(--gold-dark) 50%, 
                var(--gold-mid) 75%, 
                var(--gold-light) 100%
            );
            border: none;
            border-radius: 16px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(3rem, 15vw, 5rem);
            color: #1a1a1a;
            cursor: pointer;
            transition: all 0.2s;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            letter-spacing: 4px;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 15px rgba(218, 165, 32, 0.4),
                inset 0 2px 4px rgba(255, 255, 255, 0.5),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
        }

        .flip-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -100%;
            width: 60%;
            height: 200%;
            background: linear-gradient(
                90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0) 20%,
                rgba(255, 255, 255, 0.4) 40%,
                rgba(255, 255, 255, 0.8) 50%,
                rgba(255, 255, 255, 0.4) 60%,
                rgba(255, 255, 255, 0) 80%,
                transparent 100%
            );
            transform: skewX(-25deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        .flip-btn:hover {
            transform: scale(1.02);
            box-shadow: 
                0 8px 25px rgba(218, 165, 32, 0.6),
                inset 0 2px 4px rgba(255, 255, 255, 0.6),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
        }

        .flip-btn:active {
            transform: scale(0.98);
        }

        .flip-btn.flipping::before,
        .flip-btn.stop-mode::before {
            animation: none;
            opacity: 0;
        }

        .flip-btn.flipping {
            animation: pulse 0.3s ease infinite;
        }

        .flip-btn.stop-mode {
            background: var(--toggle-active);
            color: #000;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        body.power-save .flip-btn {
            background: var(--panel-dark);
            color: var(--text-white);
            box-shadow: none;
            text-shadow: none;
        }

        body.power-save .flip-btn::before {
            display: none;
        }

        body.power-save .flip-btn:hover {
            background: var(--panel-gray);
            box-shadow: none;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .right-toggles {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 45%;
            max-width: 180px;
        }

        .toggle-btn {
            background: var(--panel-dark);
            border: none;
            border-radius: 12px;
            padding: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: clamp(0.9rem, 3.5vw, 1.1rem);
            font-weight: 700;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn.active {
            background: var(--toggle-active);
            color: #000;
        }

        .toggle-btn:hover {
            transform: scale(1.02);
        }

        .coins-toggle {
            display: flex;
            align-items: stretch;
            gap: 0;
            flex: 1;
        }

        .coins-num-wrapper {
            background: var(--panel-gray);
            border-radius: 12px 0 0 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px 8px;
            gap: 4px;
            flex-shrink: 0;
        }

        .coins-num {
            background: transparent;
            border: none;
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            color: var(--text-white);
            text-align: center;
            outline: none;
            width: 36px;
            padding: 0;
        }

        .coins-num.flash-red {
            animation: flashRed 0.3s ease;
        }

        .coins-arrows {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .coins-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 28px;
            height: 20px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: background 0.2s;
        }

        .coins-arrow:hover {
            background: var(--panel-light);
        }

        .coins-toggle .toggle-btn {
            border-radius: 0 12px 12px 0;
            flex: 1;
        }

        .coins-toggle.active .coins-num-wrapper {
            background: var(--panel-light);
        }

        .bottom-bar {
            display: flex;
            gap: 8px;
        }

        .bottom-btn {
            flex: 1;
            background: var(--panel-dark);
            border: none;
            border-radius: 12px;
            padding: 14px 8px;
            font-family: 'Outfit', sans-serif;
            font-size: clamp(0.8rem, 3vw, 0.95rem);
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s;
        }

        .bottom-btn:hover {
            background: var(--panel-gray);
            transform: scale(1.02);
        }

        .bottom-btn.active {
            background: var(--toggle-active);
            color: #000;
        }

        .heads-tails-container {
            flex: 1.5;
            display: flex;
            gap: 0;
            position: relative;
        }

        .heads-tails-container .bottom-btn {
            border-radius: 12px;
            transition: all 0.3s;
        }

        .heads-tails-container.active .bottom-btn {
            border-radius: 12px 0 0 12px;
            font-size: clamp(0.6rem, 2vw, 0.75rem);
            white-space: nowrap;
        }

        .ht-selector {
            display: none;
            background: var(--panel-gray);
            border-radius: 0 12px 12px 0;
            overflow: hidden;
        }

        .heads-tails-container.active .ht-selector {
            display: flex;
        }

        .ht-option {
            background: transparent;
            border: none;
            padding: 8px 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ht-option.selected {
            background: var(--toggle-active);
            color: #000;
        }
        /* Tax Counters */
        .tax-counters {
            display: none;
            gap: 8px;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
        }

        .tax-counters.visible {
            display: flex;
            max-height: 60px;
            opacity: 1;
        }

        .tax-counter {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 12px;
            padding: 8px 12px;
            min-height: 52px;
            transition: all 0.3s ease;
        }

        .tax-counter.zndrsplt {
            background: #459ab5;
        }

        .tax-counter.okaun-tax {
            background: #8cdb51;
        }

        .tax-counter.other-tax {
            background: #9b59b6;
        }

        .tax-counter-label {
            flex: 1;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1rem, 4vw, 1.2rem);
            color: var(--text-white);
            letter-spacing: 1px;
            text-align: center;
        }

        .tax-counter-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tax-num {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.5rem;
            color: #000;
            min-width: 40px;
            text-align: center;
        }

        .tax-num.flash-red {
            animation: flashRed 0.3s ease;
        }

        .tax-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .tax-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 28px;
            height: 20px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s;
        }

        .tax-arrow:hover {
            background: var(--panel-gray);
        }

        /* Close Button */
        .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: var(--accent-red);
            font-size: 24px;
            font-weight: 900;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
            padding: 0;
            margin: 0;
            width: auto;
            height: auto;
        }

        .close-btn::before {
            content: '\00D7';
            display: block;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--accent-red-hover);
            transform: scale(1.1);
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            position: fixed;
            background: var(--overlay-bg);
            border-radius: 12px;
            padding: 16px;
            color: var(--text-white);
            z-index: 999;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            min-width: 280px;
            max-width: 320px;
        }

        .settings-panel.visible {
            display: block;
        }

        .settings-panel-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            margin-bottom: 16px;
            text-align: center;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .settings-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--panel-gray);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .settings-switch.active {
            background: var(--win-green);
        }

        .settings-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .settings-switch.active::after {
            transform: translateX(24px);
        }

        .settings-select {
            background: var(--panel-gray);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-white);
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            max-width: 150px;
            outline: none;
        }

        .settings-select:focus {
            background: var(--panel-light);
        }

        .settings-select option {
            background: var(--panel-dark);
            color: var(--text-white);
        }

        .settings-tax-toggles {
            display: flex;
            gap: 8px;
        }

        .settings-tax-btn {
            background: #7a8a7a;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-tax-btn:hover {
            filter: brightness(1.1);
        }

        .settings-tax-btn.active {
            background: #459ab5;
        }

        .settings-tax-btn.okaun {
            background: #aab99e;
        }

        .settings-tax-btn.okaun.active {
            background: #8cdb51;
        }

        .settings-tax-btn.other {
            background: #7a6b8a;
        }

        .settings-tax-btn.other.active {
            background: #9b59b6;
        }

        .settings-tax-btn.flash-red {
            animation: flashRedBtn 0.3s ease;
        }

        @keyframes flashRedBtn {
            0%, 100% { background: inherit; }
            50% { background: #ef4444; }
        }

        /* Okaun Words Overlay */
        .okaun-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            z-index: 600;
            flex-direction: column;
            padding: 20px;
            cursor: pointer;
        }

        .okaun-overlay.visible {
            display: flex;
        }

        .okaun-overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
        }

        .okaun-overlay-label {
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-white);
            opacity: 0.7;
        }

        .okaun-overlay-toggle {
            background: var(--panel-gray);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-family: 'Outfit', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
            display: none;
        }

        .okaun-overlay-toggle.visible {
            display: block;
        }

        .okaun-overlay-toggle:hover {
            background: var(--panel-light);
        }

        .okaun-overlay-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 0;
        }

        .okaun-overlay-text {
            width: 100%;
            text-align: center;
            color: var(--text-white);
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
            padding: 10px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 500;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .overlay.visible {
            display: flex;
        }

        .overlay-content {
            background: var(--overlay-bg);
            border-radius: 20px;
            padding: 24px;
            max-width: 360px;
            width: 100%;
            color: var(--text-white);
            max-height: 80vh;
            overflow-y: auto;
        }

        .overlay-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 2px;
            margin-bottom: 16px;
            text-align: center;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-label {
            font-weight: 600;
            opacity: 0.8;
        }

        .stat-value {
            font-weight: 700;
        }

        .stat-value.win { color: var(--win-green); }
        .stat-value.loss { color: var(--loss-red); }

        .overlay-description {
            margin-top: 16px;
            font-size: 0.85rem;
            line-height: 1.6;
            opacity: 0.8;
            text-align: center;
        }

        .overlay-btn {
            width: 100%;
            margin-top: 20px;
            background: var(--accent-red);
            border: none;
            border-radius: 12px;
            padding: 14px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .overlay-btn:hover {
            background: var(--accent-red-hover);
        }

        .overlay-btn.secondary {
            background: var(--panel-gray);
            margin-top: 10px;
        }

        @media (max-height: 700px) {
        .app-container {
                gap: 6px;
            }
            .result-panel {
                min-height: 90px;
                padding: 10px;
            }
            .okaun-panel {
                padding: 8px;
            }
            .okaun-input {
                height: 60px;
                min-height: 60px;
                max-height: 60px;
                padding: 6px;
            }
            .main-controls {
                min-height: 140px;
            }
        }

        @media (max-height: 600px) {
            body {
                padding: 4px;
            }
            .app-container {
                gap: 4px;
            }
            .result-panel {
                min-height: 70px;
                padding: 8px;
            }
            .history-bar {
                height: 24px;
            }
            .okaun-values {
                margin-bottom: 4px;
            }
            .okaun-btn {
                padding: 8px 6px;
            }
            .main-controls {
                min-height: 100px;
            }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 480px;
            }
        }

        @keyframes resultPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .result-display.animate {
            animation: resultPop 0.3s ease;
        }

        /* ========== ENCHANTMENT MODE STYLES ========== */
        body.enchantment-mode {
            background: linear-gradient(180deg, 
                #ffffff 0%,
                #f0fff0 15%,
                #c8f7c8 35%,
                #90ee90 55%,
                #5cb85c 75%,
                #3d8b3d 100%
            );
            padding: 16px;
        }

        .enchantment-container {
            display: none;
            width: 100%;
            max-width: 400px;
            flex-direction: column;
            gap: 12px;
        }

        body.enchantment-mode .app-container {
            display: none;
        }

        body.enchantment-mode .enchantment-container {
            display: flex;
        }

        .enchantment-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.8rem, 6vw, 2.4rem);
            color: var(--panel-dark);
            text-align: center;
            letter-spacing: 3px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            margin-bottom: 8px;
        }

        .ench-counter-panel {
            background: var(--panel-dark);
            border-radius: 16px;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .ench-counter-header {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ench-counter-label {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.2rem, 4.5vw, 1.5rem);
            color: var(--text-white);
            letter-spacing: 2px;
            text-align: center;
        }

        .ench-counter-content {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
        }

        .ench-counter-content-left {
            /* Empty spacer for grid layout balance */
            display: block;
        }

        .ench-counter-content-right {
            display: flex;
            justify-content: center;
        }

        .ench-counter-reset-btn {
            background: #992222;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .ench-counter-reset-btn:hover {
            background: var(--accent-red);
        }

        .ench-counter-reset-btn:active {
            transform: scale(0.95);
        }

        .ench-counter-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .ench-counter-value {
            width: 110px;
            height: 80px;
            background: var(--panel-gray);
            border: none;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(2.2rem, 9vw, 3.2rem);
            color: var(--text-white);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            cursor: text;
        }

        .ench-counter-value:focus {
            background: var(--panel-light);
        }

        .ench-counter-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .ench-counter-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 32px;
            height: 28px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s ease;
        }

        .ench-counter-arrow:hover {
            background: var(--panel-gray);
        }

        .ench-counter-arrow:active {
            transform: scale(0.95);
        }

        /* Enchantment panel size variants */
        .ench-field {
            padding: 20px 20px;
        }

        .ench-field .ench-counter-value {
            width: 120px;
            height: 90px;
            font-size: clamp(2.5rem, 10vw, 3.5rem);
        }

        .ench-field .ench-counter-arrow {
            width: 36px;
            height: 34px;
            font-size: 16px;
        }

        .ench-field .ench-counter-arrows {
            gap: 6px;
        }

        .ench-field .ench-counter-reset-btn {
            padding: 8px 14px;
            font-size: 0.8rem;
        }

        .ench-field .ench-counter-row {
            gap: 10px;
        }

        .ench-field .ench-counter-label {
            color: #90ee90;
        }

        .ench-control {
            padding: 14px 20px;
            gap: 8px;
        }

        .ench-control .ench-counter-value {
            width: 90px;
            height: 60px;
            font-size: clamp(1.8rem, 7vw, 2.4rem);
            border-radius: 10px;
        }

        .ench-control .ench-counter-arrow {
            width: 30px;
            height: 26px;
            font-size: 13px;
        }

        .ench-control .ench-counter-arrows {
            gap: 3px;
        }

        .ench-control .ench-counter-row {
            gap: 6px;
        }

        .ench-control .ench-counter-label {
            font-size: clamp(0.95rem, 3.5vw, 1.2rem);
            color: #87ceeb;
        }

        .ench-control .ench-counter-reset-btn {
            padding: 5px 10px;
            font-size: 0.7rem;
        }

        .ench-auras {
            padding: 10px 20px;
            gap: 6px;
        }

        .ench-auras .ench-counter-value {
            width: 70px;
            height: 44px;
            font-size: clamp(1.4rem, 5vw, 1.8rem);
            border-radius: 8px;
        }

        .ench-auras .ench-counter-arrow {
            width: 26px;
            height: 20px;
            font-size: 11px;
        }

        .ench-auras .ench-counter-arrows {
            gap: 2px;
        }

        .ench-auras .ench-counter-row {
            gap: 5px;
        }

        .ench-auras .ench-counter-label {
            font-size: clamp(0.85rem, 3vw, 1rem);
            color: #c9a0dc;
        }

        .ench-auras .ench-counter-reset-btn {
            padding: 4px 10px;
            font-size: 0.7rem;
        }

        /* Enchantment Commander Tax */
        .ench-commander-tax {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            gap: 12px;
        }

        .ench-commander-tax .ench-counter-label {
            flex: 1;
            font-size: clamp(1.2rem, 5vw, 1.8rem);
            text-align: center;
        }

        .ench-commander-tax .ench-counter-row {
            gap: 6px;
            flex-shrink: 0;
        }

        .ench-commander-tax .ench-counter-value {
            width: 70px;
            height: 44px;
            font-size: clamp(1.4rem, 5vw, 1.8rem);
            border-radius: 8px;
            background: transparent;
            cursor: default;
        }

        .ench-commander-tax .ench-counter-arrow {
            width: 28px;
            height: 20px;
            font-size: 11px;
        }

        /* Enchantment Reset All Button */
        .ench-reset-btn {
            background: var(--accent-red);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 1px;
        }

        .ench-reset-btn:hover {
            background: var(--accent-red-hover);
            transform: scale(1.02);
        }

        .ench-reset-btn:active {
            transform: scale(0.98);
        }

        /* Enchantment Bottom Bar */
        .ench-bottom-bar {
            display: flex;
            gap: 8px;
        }

        .ench-bottom-btn {
            flex: 1;
            background: var(--panel-dark);
            border: none;
            border-radius: 12px;
            padding: 14px 8px;
            font-family: 'Outfit', sans-serif;
            font-size: clamp(0.8rem, 3vw, 0.95rem);
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.3s;
        }

        .ench-bottom-btn:hover {
            background: var(--panel-gray);
            transform: scale(1.02);
        }

        /* Enchantment Settings Panel */
        .ench-settings-panel {
            display: none;
            position: fixed;
            background: var(--overlay-bg);
            border-radius: 12px;
            padding: 16px;
            color: var(--text-white);
            z-index: 999;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            min-width: 280px;
            max-width: 320px;
        }

        .ench-settings-panel.visible {
            display: block;
        }

        .ench-settings-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            margin-bottom: 16px;
            text-align: center;
            cursor: pointer;
        }

        .ench-settings-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 10px 0;
        }

        .ench-return-btn {
            background: var(--panel-gray);
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
        }

        .ench-return-btn:hover {
            background: var(--panel-light);
        }

        .ench-flash-red {
            animation: enchFlashRed 0.3s ease;
        }

        @keyframes enchFlashRed {
            0%, 100% { color: var(--text-white); }
            50% { color: #ef4444; }
        }

        .ench-shake {
            animation: enchShake 0.4s ease;
        }

        @keyframes enchShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px); }
            40% { transform: translateX(6px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        @media (max-height: 700px) {
            .ench-counter-panel {
                padding: 12px 16px;
                gap: 8px;
            }
            
            .ench-counter-value {
                height: 55px;
            }
            
            .enchantment-container {
                gap: 8px;
            }
        }

        /* ========== VOLTRON MODE STYLES ========== */
        .voltron-panel {
            display: none;
            background: var(--panel-dark);
            border-radius: 16px;
            padding: 16px;
            flex-direction: column;
            gap: 12px;
        }

        .enchantment-container.voltron-active .ench-counter-panel,
        .enchantment-container.voltron-active .ench-reset-btn,
        .enchantment-container.voltron-active .ench-mode-switch {
            display: none;
        }

        .enchantment-container.voltron-active .voltron-panel {
            display: flex;
        }

        /* Voltron-only elements - hidden by default, shown in voltron mode */
        .voltron-commander-tax,
        .voltron-mode-switch,
        .voltron-reset-btn {
            display: none;
        }

        .enchantment-container.voltron-active .voltron-commander-tax {
            display: flex;
        }

        /* Voltron Commander Tax - Compact styling (about half height of regular counter panels) */
        .voltron-commander-tax {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            gap: 10px;
        }

        .voltron-commander-tax .ench-counter-label {
            flex: 1;
            font-size: clamp(0.9rem, 4vw, 1.2rem);
            text-align: center;
        }

        .voltron-commander-tax .ench-counter-row {
            gap: 4px;
            flex-shrink: 0;
        }

        .voltron-commander-tax .ench-counter-value {
            width: 55px;
            height: 28px;
            font-size: clamp(1rem, 4vw, 1.3rem);
            border-radius: 6px;
            background: transparent;
            cursor: default;
        }

        .voltron-commander-tax .ench-counter-arrows {
            gap: 2px;
        }

        .voltron-commander-tax .ench-counter-arrow {
            width: 22px;
            height: 14px;
            font-size: 8px;
        }

        .enchantment-container.voltron-active .voltron-mode-switch,
        .enchantment-container.voltron-active .voltron-reset-btn {
            display: block;
        }

        .enchantment-title.lethal {
            animation: voltronLethal 0.5s ease infinite;
            font-size: clamp(2.2rem, 7vw, 2.8rem);
        }

        @keyframes voltronLethal {
            0%, 100% { 
                color: var(--panel-dark);
                transform: translateX(0) scale(1);
            }
            25% { 
                color: #ef4444;
                transform: translateX(-2px) scale(1.02);
            }
            50% { 
                color: #ff6b6b;
                transform: translateX(2px) scale(1.04);
            }
            75% { 
                color: #ef4444;
                transform: translateX(-1px) scale(1.02);
            }
        }

        .voltron-pt-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 0;
        }

        .voltron-pt-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .voltron-pt-input {
            width: 100px;
            height: 80px;
            background: var(--panel-gray);
            border: none;
            border-radius: 12px;
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(2.2rem, 9vw, 3rem);
            color: var(--text-white);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            cursor: text;
        }

        .voltron-pt-input:focus {
            background: var(--panel-light);
        }

        .voltron-pt-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .voltron-pt-arrow {
            background: var(--panel-dark);
            border: 1px solid var(--panel-gray);
            border-radius: 4px;
            width: 28px;
            height: 24px;
            color: var(--text-white);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.15s ease;
        }

        .voltron-pt-arrow:hover {
            background: var(--panel-gray);
        }

        .voltron-divider {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--text-white);
            opacity: 0.8;
        }

        .voltron-keyword-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voltron-keyword-dropdown {
            background: var(--panel-gray);
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            color: var(--text-white);
            cursor: pointer;
            outline: none;
            width: 100%;
        }

        .voltron-keyword-dropdown option {
            background: var(--panel-dark);
            color: var(--text-white);
        }

        .voltron-keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            max-height: 200px;
            overflow-y: auto;
        }

        .voltron-keyword-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--panel-gray);
            border-radius: 20px;
            padding: 6px 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .voltron-keyword-icon {
            font-size: 1rem;
        }

        .voltron-keyword-text {
            white-space: nowrap;
        }

        .voltron-keyword-remove {
            background: transparent;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
            line-height: 1;
            -webkit-text-stroke: 1px var(--accent-red);
            padding: 2px;
            transition: all 0.15s ease;
        }

        .voltron-keyword-remove:hover {
            color: var(--accent-red-hover);
            transform: scale(1.2);
        }

        .voltron-keyword-input {
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--text-white);
            color: var(--text-white);
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            width: 60px;
            padding: 2px 4px;
            outline: none;
        }

        .voltron-keyword-input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .voltron-reset-btn {
            background: var(--accent-red);
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-white);
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        .voltron-reset-btn:hover {
            background: var(--accent-red-hover);
            transform: scale(1.02);
        }

        /* Mode Switch Panel Styles */
        .mode-switch-panel {
            width: 100%;
            border: none;
            border-radius: 12px;
            padding: 14px 20px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 1px;
            text-align: center;
        }

        /* Enchantment mode - black panel */
        .mode-switch-panel.ench-mode-switch {
            background: var(--panel-dark);
            color: var(--text-white);
        }

        .mode-switch-panel.ench-mode-switch:hover {
            background: var(--panel-gray);
            transform: scale(1.02);
        }

        /* Voltron mode - white panel */
        .mode-switch-panel.voltron-mode-switch {
            background: #ffffff;
            color: var(--panel-dark);
        }

        .mode-switch-panel.voltron-mode-switch:hover {
            background: #f0f0f0;
            transform: scale(1.02);
        }


        /* Voltron toggle in settings */
        .ench-settings-toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .ench-settings-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-white);
        }

        .ench-settings-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: var(--panel-gray);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .ench-settings-switch.active {
            background: var(--win-green);
        }

        .ench-settings-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .ench-settings-switch.active::after {
            transform: translateX(24px);
        }

        /* Mode Switch Confirmation Modal */
        .mode-switch-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1500;
            justify-content: center;
            align-items: center;
        }

        .mode-switch-modal.visible {
            display: flex;
        }

        .mode-switch-content {
            background: var(--panel-dark);
            border-radius: 16px;
            padding: 24px;
            max-width: 300px;
            text-align: center;
        }

        .mode-switch-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            color: var(--text-white);
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .mode-switch-text {
            color: var(--text-white);
            font-size: 0.9rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .mode-switch-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mode-switch-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-switch-btn.primary {
            background: var(--win-green);
            color: var(--text-white);
        }

        .mode-switch-btn.primary:hover {
            filter: brightness(1.1);
        }

        .mode-switch-btn.secondary {
            background: var(--panel-gray);
            color: var(--text-white);
        }

        .mode-switch-btn.secondary:hover {
            background: var(--panel-light);
        }

        /* Fix for mobile: prevent hover state from persisting after tap */
        @media (pointer: coarse) {
            /* Disable transitions on touch to prevent stuck states */
            .okaun-arrow,
            .okaun-options-arrow,
            .okaun-plusx-arrow,
            .okaun-nav-arrow,
            .krark-arrow,
            .coins-arrow,
            .tax-arrow,
            .ench-counter-arrow,
            .voltron-pt-arrow {
                transition: none;
                -webkit-tap-highlight-color: transparent;
            }

            /* Reset hover to base backgrounds on touch devices */
            .okaun-arrow:hover,
            .okaun-options-arrow:hover,
            .okaun-plusx-arrow:hover,
            .krark-arrow:hover,
            .coins-arrow:hover,
            .tax-arrow:hover,
            .ench-counter-arrow:hover,
            .voltron-pt-arrow:hover {
                background: var(--panel-dark);
            }

            .okaun-nav-arrow:hover {
                background: var(--panel-gray);
            }

            /* Active states - only show while pressed */
            .okaun-arrow:active,
            .okaun-options-arrow:active,
            .okaun-plusx-arrow:active,
            .krark-arrow:active,
            .tax-arrow:active,
            .ench-counter-arrow:active,
            .voltron-pt-arrow:active {
                background: var(--panel-gray);
            }

            .okaun-nav-arrow:active,
            .coins-arrow:active {
                background: var(--panel-light);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Result Display Panel -->
        <div class="result-panel">
            <div class="result-display" id="resultDisplay"></div>
            <div class="history-bar" id="historyBar"></div>
        </div>

        <!-- Okaun Panel -->
        <div class="okaun-panel collapsed" id="okaunPanel">
            <button class="okaun-btn okaun-toggle-btn" id="okaunToggle">
                Okaun?
            </button>
            <div class="okaun-content" id="okaunContent">
                <button class="okaun-nav-arrow left" id="okaunNavLeft"></button>
                <button class="okaun-nav-arrow right" id="okaunNavRight"></button>
                <div class="okaun-header">
                    <div class="okaun-number-indicator" id="okaunNumberIndicator">#1</div>
                    <div class="okaun-title">OKAUN-O-METER</div>
                    <div class="okaun-icons">
                        <button class="okaun-icon-btn" id="speakerBtn" title="Read aloud">
                            <svg id="speakerIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                            <svg id="speakerMuteIcon" style="display:none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
                            </svg>
                        </button>
                        <button class="okaun-icon-btn" id="eyeBtn" title="View full numbers">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </button>
                        <button class="okaun-options-btn" id="okaunOptionsBtn" title="Options"></button>
                    </div>
                </div>
                <div class="okaun-carousel-container">
                    <div class="okaun-carousel-track" id="okaunCarouselTrack">
                        <div class="okaun-slide" data-okaun-index="0">
                            <div class="okaun-values">
                                <div class="okaun-input-wrapper">
                                    <div class="okaun-input" data-field="power" contenteditable="true">3</div>
                                    <div class="okaun-arrows">
                                        <button class="okaun-arrow" data-action="power-up"></button>
                                        <button class="okaun-arrow" data-action="power-down"></button>
                                    </div>
                                </div>
                                <span class="okaun-divider">/</span>
                                <div class="okaun-input-wrapper">
                                    <div class="okaun-input" data-field="toughness" contenteditable="true">3</div>
                                    <div class="okaun-arrows">
                                        <button class="okaun-arrow" data-action="toughness-up"></button>
                                        <button class="okaun-arrow" data-action="toughness-down"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="okaun-buttons">
                    <button class="okaun-btn" id="endTurn">
                        End Turn
                    </button>
                    <button class="okaun-collapse-btn" id="okaunCollapse">
                        OKAUN!
                    </button>
                </div>
            </div>
        </div>

        <!-- Krark's Thumb Toggle -->
        <div class="krark-toggle" id="krarkToggle">
            <span class="krark-text" id="krarkText">Krark's Thumb?</span>
            <div class="krark-counter">
                <span class="krark-num" id="krarkNum">1</span>
                <div class="krark-arrows">
                    <button class="krark-arrow" id="krarkUp"></button>
                    <button class="krark-arrow" id="krarkDown"></button>
                </div>
            </div>
        </div>

        <!-- Main Controls -->
        <div class="main-controls">
            <div class="flip-btn-container">
                <button class="flip-btn" id="flipBtn">FLIP</button>
                <button class="undo-flip-btn" id="undoFlipBtn"> Undo</button>
            </div>
            <div class="right-toggles">
                <button class="toggle-btn" id="untilLoss">
                    Until Loss?
                </button>
                <button class="toggle-btn" id="until2Losses">
                    Until 2 Losses?
                </button>
                <div class="coins-toggle" id="coinsToggle">
                    <div class="coins-num-wrapper">
                        <input type="number" class="coins-num" id="coinsNum" value="5" min="1" max="999">
                        <div class="coins-arrows">
                            <button class="coins-arrow" id="coinsUp"></button>
                            <button class="coins-arrow" id="coinsDown"></button>
                        </div>
                    </div>
                    <button class="toggle-btn" id="coinsBtn">
                        Coins?
                    </button>
                </div>
            </div>
        </div>

        <!-- Tax Counters -->
        <div class="tax-counters" id="taxCounters">
            <div class="tax-counter zndrsplt" id="zndrspltCounter" style="display: none;">
                <span class="tax-counter-label">Zndrsplt Tax</span>
                <div class="tax-counter-controls">
                    <span class="tax-num" id="zndrspltNum">+0</span>
                    <div class="tax-arrows">
                        <button class="tax-arrow" id="zndrspltUp"></button>
                        <button class="tax-arrow" id="zndrspltDown"></button>
                    </div>
                </div>
            </div>
            <div class="tax-counter okaun-tax" id="okaunTaxCounter" style="display: none;">
                <span class="tax-counter-label">Okaun Tax</span>
                <div class="tax-counter-controls">
                    <span class="tax-num" id="okaunTaxNum">+0</span>
                    <div class="tax-arrows">
                        <button class="tax-arrow" id="okaunTaxUp"></button>
                        <button class="tax-arrow" id="okaunTaxDown"></button>
                    </div>
                </div>
            </div>
            <div class="tax-counter other-tax" id="otherTaxCounter" style="display: none;">
                <span class="tax-counter-label">Commander Tax</span>
                <div class="tax-counter-controls">
                    <span class="tax-num" id="otherTaxNum">+0</span>
                    <div class="tax-arrows">
                        <button class="tax-arrow" id="otherTaxUp"></button>
                        <button class="tax-arrow" id="otherTaxDown"></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Bar -->
        <div class="bottom-bar">
            <button class="bottom-btn" id="helpBtn">Extras</button>
            <button class="bottom-btn" id="statsBtn">Stats</button>
            <div class="heads-tails-container" id="htContainer">
                <button class="bottom-btn" id="htBtn">Heads/Tails Mode?</button>
                <div class="ht-selector">
                    <button class="ht-option" id="htHeads">H</button>
                    <button class="ht-option selected" id="htTails">T</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enchantment Mode Container -->
    <div class="enchantment-container" id="enchantmentContainer">
        <div class="enchantment-title" id="enchantmentTitle">ENCHANTMENT TRACKER</div>

        <!-- Enchantments on Field -->
        <div class="ench-counter-panel ench-field">
            <div class="ench-counter-header">
                <div class="ench-counter-label">ENCHANTMENTS ON FIELD</div>
            </div>
            <div class="ench-counter-content">
                <div class="ench-counter-content-left"></div>
                <div class="ench-counter-row">
                    <div class="ench-counter-value" id="enchFieldValue" contenteditable="true">0</div>
                    <div class="ench-counter-arrows">
                        <button class="ench-counter-arrow" id="enchFieldUp"></button>
                        <button class="ench-counter-arrow" id="enchFieldDown"></button>
                    </div>
                </div>
                <div class="ench-counter-content-right">
                    <button class="ench-counter-reset-btn" id="enchFieldReset">Reset</button>
                </div>
            </div>
        </div>

        <!-- Enchantments You Control -->
        <div class="ench-counter-panel ench-control">
            <div class="ench-counter-header">
                <div class="ench-counter-label">ENCHANTMENTS YOU CONTROL</div>
            </div>
            <div class="ench-counter-content">
                <div class="ench-counter-content-left"></div>
                <div class="ench-counter-row">
                    <div class="ench-counter-value" id="enchControlValue" contenteditable="true">0</div>
                    <div class="ench-counter-arrows">
                        <button class="ench-counter-arrow" id="enchControlUp"></button>
                        <button class="ench-counter-arrow" id="enchControlDown"></button>
                    </div>
                </div>
                <div class="ench-counter-content-right">
                    <button class="ench-counter-reset-btn" id="enchControlReset">Reset</button>
                </div>
            </div>
        </div>

        <!-- Auras You Control -->
        <div class="ench-counter-panel ench-auras">
            <div class="ench-counter-header">
                <div class="ench-counter-label">AURAS YOU CONTROL</div>
            </div>
            <div class="ench-counter-content">
                <div class="ench-counter-content-left"></div>
                <div class="ench-counter-row">
                    <div class="ench-counter-value" id="enchAurasValue" contenteditable="true">0</div>
                    <div class="ench-counter-arrows">
                        <button class="ench-counter-arrow" id="enchAurasUp"></button>
                        <button class="ench-counter-arrow" id="enchAurasDown"></button>
                    </div>
                </div>
                <div class="ench-counter-content-right">
                    <button class="ench-counter-reset-btn" id="enchAurasReset">Reset</button>
                </div>
            </div>
        </div>

        <!-- Mode Switch Panel (Enchantment Mode) -->
        <button class="mode-switch-panel ench-mode-switch" id="enchModeSwitch">Switch to Voltron Mode</button>

        <!-- Reset All Button -->
        <button class="ench-reset-btn" id="enchResetAll">RESET ALL</button>

        <!-- Voltron Mode Panel -->
        <div class="voltron-panel" id="voltronPanel">
            <div class="voltron-pt-container">
                <div class="voltron-pt-wrapper">
                    <div class="voltron-pt-input" id="voltronPower" contenteditable="true">5</div>
                    <div class="voltron-pt-arrows">
                        <button class="voltron-pt-arrow" id="voltronPowerUp"></button>
                        <button class="voltron-pt-arrow" id="voltronPowerDown"></button>
                    </div>
                </div>
                <span class="voltron-divider">/</span>
                <div class="voltron-pt-wrapper">
                    <div class="voltron-pt-input" id="voltronToughness" contenteditable="true">5</div>
                    <div class="voltron-pt-arrows">
                        <button class="voltron-pt-arrow" id="voltronToughnessUp"></button>
                        <button class="voltron-pt-arrow" id="voltronToughnessDown"></button>
                    </div>
                </div>
            </div>
            <div class="voltron-keyword-section">
                <select class="voltron-keyword-dropdown" id="voltronKeywordDropdown">
                    <option value="">Add keyword...</option>
                    <option value="flying">Flying</option>
                    <option value="trample">Trample</option>
                    <option value="lifelink">Lifelink</option>
                    <option value="pseudo-lifelink">Pseudo Lifelink</option>
                    <option value="deathtouch">Deathtouch</option>
                    <option value="first-strike">First Strike</option>
                    <option value="double-strike">Double Strike</option>
                    <option value="vigilance">Vigilance</option>
                    <option value="haste">Haste</option>
                    <option value="hexproof">Hexproof</option>
                    <option value="indestructible">Indestructible</option>
                    <option value="menace">Menace</option>
                    <option value="reach">Reach</option>
                    <option value="shroud">Shroud</option>
                    <option value="ward">Ward</option>
                    <option value="protection">Protection from...</option>
                </select>
                <div class="voltron-keywords-list" id="voltronKeywordsList"></div>
            </div>
        </div>

        <!-- Commander Tax (Voltron Mode Only) -->
        <div class="ench-counter-panel voltron-commander-tax">
            <div class="ench-counter-label">COMMANDER TAX</div>
            <div class="ench-counter-row">
                <div class="ench-counter-value" id="enchCommanderTaxValue">+0</div>
                <div class="ench-counter-arrows">
                    <button class="ench-counter-arrow" id="enchCommanderTaxUp"></button>
                    <button class="ench-counter-arrow" id="enchCommanderTaxDown"></button>
                </div>
            </div>
        </div>

        <!-- Mode Switch Panel (Voltron Mode) -->
        <button class="mode-switch-panel voltron-mode-switch" id="voltronModeSwitchPanel">Switch to Enchantment Tracking Mode</button>
        
        <!-- Reset All Button (Voltron Mode) -->
        <button class="voltron-reset-btn" id="voltronResetAll">RESET ALL</button>

        <!-- Enchantment Bottom Bar -->
        <div class="ench-bottom-bar">
            <button class="ench-bottom-btn" id="enchExtrasBtn">Extras</button>
        </div>
    </div>

    <!-- Enchantment Settings Panel -->
    <div class="ench-settings-panel" id="enchSettingsPanel">
        <button class="close-btn" id="enchSettingsClose"></button>
        <div class="ench-settings-title">SETTINGS</div>
        <div class="ench-settings-row">
            <button class="ench-return-btn" id="enchReturnBtn">Return to Coinflip Mode</button>
        </div>
    </div>

    <!-- Mode Switch Confirmation Modal -->
    <div class="mode-switch-modal" id="modeSwitchModal">
        <div class="mode-switch-content">
            <div class="mode-switch-title">SWITCH MODES?</div>
            <p class="mode-switch-text">Woah! You found the secret enchantment/voltron mode I included just for me. Using this mode will reset all of your coinflips, stats, and other coin-y business. Are you sure you want to proceed?</p>
            <div class="mode-switch-buttons">
                <button class="mode-switch-btn primary" id="modeSwitchConfirm">Yes, Switch Modes</button>
                <button class="mode-switch-btn secondary" id="modeSwitchCancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <button class="close-btn" id="settingsClose"></button>
        <div class="settings-panel-title" id="settingsPanelTitle">SETTINGS</div>
        <div class="settings-row">
            <span class="settings-label">Simple Mode</span>
            <div class="settings-switch" id="simpleModeSwitch"></div>
        </div>
        <div class="settings-row">
            <span class="settings-label">Voice</span>
            <select class="settings-select" id="voiceSelect">
                <option value="default">Default</option>
            </select>
        </div>
        <div class="settings-row">
            <span class="settings-label">Track Tax?</span>
            <div class="settings-switch" id="trackTaxSwitch"></div>
        </div>
        <div class="settings-row" id="trackTaxOptionsRow" style="display: none;">
            <span class="settings-label">Track</span>
            <div class="settings-tax-toggles">
                <button class="settings-tax-btn" id="trackZndrspltBtn">Zndrsplt</button>
                <button class="settings-tax-btn okaun" id="trackOkaunBtn">Okaun</button>
                <button class="settings-tax-btn other" id="trackOtherBtn">Other</button>
            </div>
        </div>
    </div>

    <!-- Okaun Options Modal -->
    <div class="okaun-options-modal" id="okaunOptionsModal">
        <div class="okaun-options-content">
            <button class="close-btn" id="okaunOptionsClose"></button>
            <div class="okaun-options-title">OKAUN OPTIONS</div>
            <div class="okaun-options-row">
                <span class="okaun-options-label">Number of Okauns</span>
                <div class="okaun-options-counter">
                    <span class="okaun-options-num" id="okaunCountNum">&times;1</span>
                    <div class="okaun-options-arrows">
                        <button class="okaun-options-arrow" id="okaunCountUp"></button>
                        <button class="okaun-options-arrow" id="okaunCountDown"></button>
                    </div>
                </div>
            </div>
            <div class="okaun-options-row">
                <span class="okaun-options-label">+X/+X on Win</span>
                <div class="okaun-options-switch" id="okaunPlusXSwitch"></div>
            </div>
            <div class="okaun-plusx-inputs" id="okaunPlusXInputs">
                <span class="okaun-plusx-label">+</span>
                <div class="okaun-plusx-counter">
                    <span class="okaun-plusx-num" id="okaunPlusXPowerNum">1</span>
                    <div class="okaun-plusx-arrows">
                        <button class="okaun-plusx-arrow" id="okaunPlusXPowerUp"></button>
                        <button class="okaun-plusx-arrow" id="okaunPlusXPowerDown"></button>
                    </div>
                </div>
                <span class="okaun-plusx-label">/+</span>
                <div class="okaun-plusx-counter">
                    <span class="okaun-plusx-num" id="okaunPlusXToughnessNum">1</span>
                    <div class="okaun-plusx-arrows">
                        <button class="okaun-plusx-arrow" id="okaunPlusXToughnessUp"></button>
                        <button class="okaun-plusx-arrow" id="okaunPlusXToughnessDown"></button>
                    </div>
                </div>
            </div>
            <div class="okaun-options-btn-row">
                <button class="okaun-options-action" id="resetThisOkaun">Reset This Okaun</button>
                <button class="okaun-options-action danger" id="resetAllOkauns">Reset ALL Okauns</button>
            </div>
        </div>
    </div>

    <!-- Reset All Okauns Confirmation -->
    <div class="confirm-modal" id="resetAllConfirm">
        <div class="confirm-content">
            <p class="confirm-text">Are you sure you want to reset ALL Okauns to 3/3?</p>
            <div class="confirm-buttons">
                <button class="confirm-btn primary" id="resetAllYes">Yes, Reset All</button>
                <button class="confirm-btn secondary" id="resetAllNo">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Remove Okaun Confirmation -->
    <div class="confirm-modal" id="removeOkaunConfirm">
        <div class="confirm-content">
            <p class="confirm-text">Remove an Okaun?</p>
            <div class="confirm-buttons">
                <button class="confirm-btn primary" id="removeOkaunYes">OK</button>
                <button class="confirm-btn secondary small-text" id="removeOkaunDontAsk">OK, Don't Ask Again</button>
                <button class="confirm-btn secondary" id="removeOkaunNo">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Remove Last Okaun Confirmation (when going to 0) -->
    <div class="confirm-modal" id="removeLastOkaunConfirm">
        <div class="confirm-content">
            <p class="confirm-text">Remove The Last Okaun?</p>
            <div class="confirm-buttons">
                <button class="confirm-btn primary" id="removeLastOkaunYes">OK</button>
                <button class="confirm-btn secondary small-text" id="removeLastOkaunDontAsk">OK, Don't Ask Again</button>
                <button class="confirm-btn secondary" id="removeLastOkaunNo">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Okaun Words Overlay -->
    <div class="okaun-overlay" id="okaunOverlay">
        <div class="okaun-overlay-header">
            <div class="okaun-overlay-label" id="okaunOverlayLabel">Okaun's Power and Toughness are:</div>
            <button class="okaun-overlay-toggle" id="okaunOverlayToggle">Toughness</button>
        </div>
        <div class="okaun-overlay-content">
            <div class="okaun-overlay-text" id="okaunOverlayText"></div>
        </div>
    </div>

    <!-- Stats Overlay -->
    <div class="overlay" id="statsOverlay">
        <div class="overlay-content">
            <div class="overlay-title">STATISTICS</div>
            <div class="stat-row">
                <span class="stat-label">Total Wins</span>
                <span class="stat-value win" id="statWins">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Total Losses</span>
                <span class="stat-value loss" id="statLosses">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Win Rate</span>
                <span class="stat-value" id="statWinRate">0%</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Total Flips</span>
                <span class="stat-value" id="statTotal">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Longest Win Streak</span>
                <span class="stat-value win" id="statWinStreak">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Longest Loss Streak</span>
                <span class="stat-value loss" id="statLossStreak">0</span>
            </div>
            <p class="overlay-description">
                Randomization uses JavaScript's Math.random(), which generates cryptographically 
                pseudo-random numbers via the browser's underlying algorithm. Each flip is 
                independent with a true 50/50 probability.
            </p>
            <button class="overlay-btn" id="resetStats">Reset Stats</button>
            <button class="overlay-btn secondary" id="closeStats">Close</button>
        </div>
    </div>


    <script>
        // Reusable canvas for text measurement (performance optimization)
        const measureCanvas = document.createElement('canvas');
        const measureCtx = measureCanvas.getContext('2d');

        // Number to words converter
        const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine',
                      'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen',
                      'seventeen', 'eighteen', 'nineteen'];
        const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        
        const largeNumbers = [
            '', 'thousand', 'million', 'billion', 'trillion', 'quadrillion', 'quintillion',
            'sextillion', 'septillion', 'octillion', 'nonillion', 'decillion', 'undecillion',
            'duodecillion', 'tredecillion', 'quattuordecillion', 'quindecillion', 'sexdecillion',
            'septendecillion', 'octodecillion', 'novemdecillion', 'vigintillion', 'unvigintillion',
            'duovigintillion', 'trevigintillion', 'quattuorvigintillion', 'quinvigintillion',
            'sexvigintillion', 'septenvigintillion', 'octovigintillion', 'novemvigintillion',
            'trigintillion', 'untrigintillion', 'duotrigintillion', 'tretrigintillion',
            'quattuortrigintillion', 'quintrigintillion', 'sextrigintillion', 'septentrigintillion',
            'octotrigintillion', 'novemtrigintillion', 'quadragintillion', 'unquadragintillion',
            'duoquadragintillion', 'trequadragintillion', 'quattuorquadragintillion',
            'quinquadragintillion', 'sexquadragintillion', 'septenquadragintillion',
            'octoquadragintillion', 'novemquadragintillion', 'quinquagintillion',
            'unquinquagintillion', 'duoquinquagintillion', 'trequinquagintillion',
            'quattuorquinquagintillion', 'quinquinquagintillion', 'sexquinquagintillion',
            'septenquinquagintillion', 'octoquinquagintillion', 'novemquinquagintillion',
            'sexagintillion', 'unsexagintillion', 'duosexagintillion', 'tresexagintillion',
            'quattuorsexagintillion', 'quinsexagintillion', 'sexsexagintillion',
            'septensexagintillion', 'octosexagintillion', 'novemsexagintillion',
            'septuagintillion', 'unseptuagintillion', 'duoseptuagintillion', 'treseptuagintillion',
            'quattuorseptuagintillion', 'quinseptuagintillion', 'sexseptuagintillion',
            'septenseptuagintillion', 'octoseptuagintillion', 'novemseptuagintillion',
            'octogintillion', 'unoctogintillion', 'duooctogintillion', 'treoctogintillion',
            'quattuoroctogintillion', 'quinoctogintillion', 'sexoctogintillion',
            'septenoctogintillion', 'octooctogintillion', 'novemoctogintillion',
            'nonagintillion', 'unnonagintillion', 'duononagintillion', 'trenonagintillion',
            'quattuornonagintillion', 'quinnonagintillion', 'sexnonagintillion',
            'septennonagintillion', 'octononagintillion', 'novemnonagintillion',
            'centillion'
        ];

        function convertHundreds(num) {
            let result = '';
            num = parseInt(num);
            if (num >= 100) {
                result += ones[Math.floor(num / 100)] + ' hundred';
                num %= 100;
                if (num > 0) result += ' ';
            }
            if (num >= 20) {
                result += tens[Math.floor(num / 10)];
                num %= 10;
                if (num > 0) result += '-' + ones[num];
            } else if (num > 0) {
                result += ones[num];
            }
            return result;
        }

        function numberToWords(num) {
            if (typeof num === 'bigint') {
                if (num === 0n) return 'zero';
                if (num < 0n) return 'negative ' + numberToWords(-num);
                return numberToWordsFromString(num.toString());
            }
            
            if (num === 0) return 'zero';
            if (num < 0) return 'negative ' + numberToWords(-num);
            
            let numStr = '';
            if (typeof num === 'number') {
                if (num >= 1e21) {
                    numStr = bigNumberToString(num);
                } else {
                    numStr = Math.floor(num).toString();
                }
            } else {
                numStr = num.toString();
            }
            
            return numberToWordsFromString(numStr);
        }
        
        function numberToWordsFromString(numStr) {
            numStr = numStr.replace(/[^0-9]/g, '');
            
            if (numStr === '' || numStr === '0') return 'zero';
            
            numStr = numStr.replace(/^0+/, '') || '0';
            
            while (numStr.length % 3 !== 0) {
                numStr = '0' + numStr;
            }
            
            const groups = [];
            for (let i = 0; i < numStr.length; i += 3) {
                groups.push(numStr.substring(i, i + 3));
            }
            
            const numGroups = groups.length;
            const parts = [];
            
            for (let i = 0; i < numGroups; i++) {
                const groupValue = parseInt(groups[i]);
                if (groupValue === 0) continue;
                
                const groupIndex = numGroups - 1 - i;
                const groupWords = convertHundreds(groupValue);
                
                if (groupIndex > 0) {
                    if (groupIndex < largeNumbers.length) {
                        parts.push(groupWords + ' ' + largeNumbers[groupIndex]);
                    } else {
                        const power = groupIndex * 3;
                        parts.push(groupWords + ' times ten to the ' + numberToWords(power));
                    }
                } else {
                    parts.push(groupWords);
                }
            }
            
            return parts.join(' ') || 'zero';
        }

        function bigNumberToString(num) {
            if (num < 1e21) {
                return Math.floor(num).toString();
            }
            
            const str = num.toExponential();
            const match = str.match(/^(\d)\.?(\d*)e\+(\d+)$/);
            
            if (!match) return Math.floor(num).toString();
            
            const firstDigit = match[1];
            const decimals = match[2] || '';
            const exponent = parseInt(match[3]);
            
            let result = firstDigit + decimals;
            const zerosNeeded = exponent - decimals.length;
            
            if (zerosNeeded > 0) {
                result += '0'.repeat(zerosNeeded);
            } else if (zerosNeeded < 0) {
                result = result.substring(0, exponent + 1);
            }
            
            return result;
        }

        // State
        const state = {
            // Multiple Okauns - each has: power, toughness, basePower, baseToughness, plusXActive, plusXPower, plusXToughness
            okauns: [{
                power: 3n,
                toughness: 3n,
                basePower: 3n,
                baseToughness: 3n,
                plusXActive: false,
                plusXPower: 1n,
                plusXToughness: 1n
            }],
            currentOkaunIndex: 0,
            okaunActive: false,
            removeOkaunConfirmDisabled: false,
            
            krarkActive: false,
            krarkCount: 1,
            untilLossActive: false,
            until2LossesActive: false,
            coinsActive: false,
            coinsCount: 5,
            htActive: false,
            htMode: 'tails',
            simpleMode: false,
            
            trackTaxActive: false,
            trackZndrsplt: false,
            trackOkaun: false,
            trackOther: false,
            zndrspltTax: 0,
            okaunTax: 0,
            otherTax: 0,
            
            isFlipping: false,
            stopRequested: false,
            isSpeaking: false,
            
            overlayShowingPower: true,
            
            selectedVoice: null,
            availableVoices: [],
            
            history: [],
            
            stats: {
                wins: 0,
                losses: 0,
                longestWinStreak: 0,
                longestLossStreak: 0,
                currentWinStreak: 0,
                currentLossStreak: 0
            },
            
            // For undo functionality (stack for multiple undos)
            undoStack: [],
            canUndo: false
        };


        const els = {
            resultDisplay: document.getElementById('resultDisplay'),
            historyBar: document.getElementById('historyBar'),
            okaunPanel: document.getElementById('okaunPanel'),
            okaunContent: document.getElementById('okaunContent'),
            endTurn: document.getElementById('endTurn'),
            okaunToggle: document.getElementById('okaunToggle'),
            okaunCollapse: document.getElementById('okaunCollapse'),
            okaunOptionsBtn: document.getElementById('okaunOptionsBtn'),
            okaunOptionsModal: document.getElementById('okaunOptionsModal'),
            okaunCountNum: document.getElementById('okaunCountNum'),
            okaunCountUp: document.getElementById('okaunCountUp'),
            okaunCountDown: document.getElementById('okaunCountDown'),
            okaunPlusXSwitch: document.getElementById('okaunPlusXSwitch'),
            okaunPlusXInputs: document.getElementById('okaunPlusXInputs'),
            okaunPlusXPowerNum: document.getElementById('okaunPlusXPowerNum'),
            okaunPlusXToughnessNum: document.getElementById('okaunPlusXToughnessNum'),
            okaunPlusXPowerUp: document.getElementById('okaunPlusXPowerUp'),
            okaunPlusXPowerDown: document.getElementById('okaunPlusXPowerDown'),
            okaunPlusXToughnessUp: document.getElementById('okaunPlusXToughnessUp'),
            okaunPlusXToughnessDown: document.getElementById('okaunPlusXToughnessDown'),
            resetThisOkaun: document.getElementById('resetThisOkaun'),
            resetAllOkauns: document.getElementById('resetAllOkauns'),
            resetAllConfirm: document.getElementById('resetAllConfirm'),
            resetAllYes: document.getElementById('resetAllYes'),
            resetAllNo: document.getElementById('resetAllNo'),
            removeOkaunConfirm: document.getElementById('removeOkaunConfirm'),
            removeOkaunYes: document.getElementById('removeOkaunYes'),
            removeOkaunDontAsk: document.getElementById('removeOkaunDontAsk'),
            removeOkaunNo: document.getElementById('removeOkaunNo'),
            removeLastOkaunConfirm: document.getElementById('removeLastOkaunConfirm'),
            removeLastOkaunYes: document.getElementById('removeLastOkaunYes'),
            removeLastOkaunDontAsk: document.getElementById('removeLastOkaunDontAsk'),
            removeLastOkaunNo: document.getElementById('removeLastOkaunNo'),
            okaunCarouselTrack: document.getElementById('okaunCarouselTrack'),
            okaunNavLeft: document.getElementById('okaunNavLeft'),
            okaunNavRight: document.getElementById('okaunNavRight'),
            okaunNumberIndicator: document.getElementById('okaunNumberIndicator'),
            resultPanel: document.querySelector('.result-panel'),
            speakerBtn: document.getElementById('speakerBtn'),
            speakerIcon: document.getElementById('speakerIcon'),
            speakerMuteIcon: document.getElementById('speakerMuteIcon'),
            eyeBtn: document.getElementById('eyeBtn'),
            okaunOverlay: document.getElementById('okaunOverlay'),
            okaunOverlayLabel: document.getElementById('okaunOverlayLabel'),
            okaunOverlayToggle: document.getElementById('okaunOverlayToggle'),
            okaunOverlayText: document.getElementById('okaunOverlayText'),
            krarkToggle: document.getElementById('krarkToggle'),
            krarkText: document.getElementById('krarkText'),
            krarkNum: document.getElementById('krarkNum'),
            krarkUp: document.getElementById('krarkUp'),
            krarkDown: document.getElementById('krarkDown'),
            flipBtn: document.getElementById('flipBtn'),
            untilLoss: document.getElementById('untilLoss'),
            until2Losses: document.getElementById('until2Losses'),
            coinsToggle: document.getElementById('coinsToggle'),
            coinsBtn: document.getElementById('coinsBtn'),
            coinsNum: document.getElementById('coinsNum'),
            coinsUp: document.getElementById('coinsUp'),
            coinsDown: document.getElementById('coinsDown'),
            undoFlipBtn: document.getElementById('undoFlipBtn'),
            mainControls: document.querySelector('.main-controls'),
            helpBtn: document.getElementById('helpBtn'),
            settingsPanel: document.getElementById('settingsPanel'),
            settingsClose: document.getElementById('settingsClose'),
            okaunOptionsClose: document.getElementById('okaunOptionsClose'),
            simpleModeSwitch: document.getElementById('simpleModeSwitch'),
            voiceSelect: document.getElementById('voiceSelect'),
            trackTaxSwitch: document.getElementById('trackTaxSwitch'),
            trackTaxOptionsRow: document.getElementById('trackTaxOptionsRow'),
            trackZndrspltBtn: document.getElementById('trackZndrspltBtn'),
            trackOkaunBtn: document.getElementById('trackOkaunBtn'),
            trackOtherBtn: document.getElementById('trackOtherBtn'),
            taxCounters: document.getElementById('taxCounters'),
            zndrspltCounter: document.getElementById('zndrspltCounter'),
            okaunTaxCounter: document.getElementById('okaunTaxCounter'),
            otherTaxCounter: document.getElementById('otherTaxCounter'),
            zndrspltNum: document.getElementById('zndrspltNum'),
            okaunTaxNum: document.getElementById('okaunTaxNum'),
            otherTaxNum: document.getElementById('otherTaxNum'),
            zndrspltUp: document.getElementById('zndrspltUp'),
            zndrspltDown: document.getElementById('zndrspltDown'),
            okaunTaxUp: document.getElementById('okaunTaxUp'),
            okaunTaxDown: document.getElementById('okaunTaxDown'),
            otherTaxUp: document.getElementById('otherTaxUp'),
            otherTaxDown: document.getElementById('otherTaxDown'),
            statsBtn: document.getElementById('statsBtn'),
            htContainer: document.getElementById('htContainer'),
            htBtn: document.getElementById('htBtn'),
            htHeads: document.getElementById('htHeads'),
            htTails: document.getElementById('htTails'),
            statsOverlay: document.getElementById('statsOverlay'),
            statWins: document.getElementById('statWins'),
            statLosses: document.getElementById('statLosses'),
            statWinRate: document.getElementById('statWinRate'),
            statTotal: document.getElementById('statTotal'),
            statWinStreak: document.getElementById('statWinStreak'),
            statLossStreak: document.getElementById('statLossStreak'),
            resetStats: document.getElementById('resetStats'),
            closeStats: document.getElementById('closeStats')
        };

        // Initialize system voices
        function initVoices() {
            if (!window.speechSynthesis) return;
            
            const voices = window.speechSynthesis.getVoices();
            state.availableVoices = voices;
            
            els.voiceSelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = 'default';
            defaultOption.textContent = 'Default';
            els.voiceSelect.appendChild(defaultOption);
            
            if (voices.length > 0) {
                voices.forEach((voice, index) => {
                    const option = document.createElement('option');
                    option.value = 'system_' + index;
                    let label = voice.name;
                    if (voice.lang) {
                        label += ` (${voice.lang})`;
                    }
                    option.textContent = label.substring(0, 40) + (label.length > 40 ? '...' : '');
                    els.voiceSelect.appendChild(option);
                });
            }
        }

        if (window.speechSynthesis) {
            initVoices();
            window.speechSynthesis.onvoiceschanged = initVoices;
        }

        function flipCoin() {
            return Math.random() < 0.5;
        }

        function fitTextInContainer(element, text) {
            // Use the element's own fixed dimensions
            const maxWidth = (element.offsetWidth || 85) - 16;
            const maxHeight = (element.offsetHeight || 70) - 16;
            
            const minFontSize = 8;
            const maxFontSize = 48;
            
            // Try to fit on one line first
            for (let size = maxFontSize; size >= minFontSize; size -= 2) {
                measureCtx.font = `${size}px "Bebas Neue"`;
                const metrics = measureCtx.measureText(text);
                if (metrics.width <= maxWidth) {
                    return { fontSize: size, wrap: false, useScientific: false };
                }
            }
            
            // Try wrapping to multiple lines (allow up to 4 lines before scientific)
            for (let size = 24; size >= minFontSize; size -= 2) {
                measureCtx.font = `${size}px "Bebas Neue"`;
                const charWidth = measureCtx.measureText('0').width;
                const charsPerLine = Math.floor(maxWidth / charWidth);
                const lines = Math.ceil(text.length / charsPerLine);
                const lineHeight = size * 1.0;
                const totalHeight = lines * lineHeight;
                
                if (totalHeight <= maxHeight && charsPerLine >= 3) {
                    return { fontSize: size, wrap: true, useScientific: false };
                }
            }
            
            return { fontSize: 12, wrap: false, useScientific: true };
        }

        function formatOkaunValue(val) {
            const strVal = val.toString();
            // Allow more digits before going to scientific notation (for multi-line wrapping)
            if (strVal.length > 24) {
                const exp = strVal.length - 1;
                const mantissa = strVal[0] + '.' + strVal.substring(1, 3);
                return { text: mantissa + 'e+' + exp, isScientific: true };
            }
            return { text: strVal.replace(/\B(?=(\d{3})+(?!\d))/g, ','), isScientific: false };
        }

        function applyValueToElement(el, val) {
            const formatted = formatOkaunValue(val);
            if (formatted.isScientific) {
                el.textContent = formatted.text;
                el.style.fontSize = '14px';
                el.style.fontFamily = "'Outfit', sans-serif";
                el.style.fontWeight = '700';
                el.style.wordBreak = 'normal';
                el.style.whiteSpace = 'nowrap';
            } else {
                const sizing = fitTextInContainer(el, formatted.text);
                if (sizing.useScientific) {
                    const strVal = val.toString();
                    const exp = strVal.length - 1;
                    const mantissa = strVal[0] + '.' + strVal.substring(1, 3);
                    el.textContent = mantissa + 'e+' + exp;
                    el.style.fontSize = '14px';
                    el.style.fontFamily = "'Outfit', sans-serif";
                    el.style.fontWeight = '700';
                    el.style.wordBreak = 'normal';
                    el.style.whiteSpace = 'nowrap';
                } else {
                    el.textContent = formatted.text;
                    el.style.fontSize = sizing.fontSize + 'px';
                    el.style.fontFamily = "'Bebas Neue', sans-serif";
                    el.style.fontWeight = 'normal';
                    if (sizing.wrap) {
                        el.style.wordBreak = 'break-all';
                        el.style.whiteSpace = 'normal';
                        el.style.lineHeight = '1.1';
                    } else {
                        el.style.wordBreak = 'normal';
                        el.style.whiteSpace = 'nowrap';
                        el.style.lineHeight = 'normal';
                    }
                }
            }
        }

        function updateOkaunDisplay() {
            // Update all Okaun slides
            state.okauns.forEach((okaun, index) => {
                const slide = els.okaunCarouselTrack.querySelector(`[data-okaun-index="${index}"]`);
                if (slide) {
                    const powerEl = slide.querySelector('[data-field="power"]');
                    const toughnessEl = slide.querySelector('[data-field="toughness"]');
                    if (powerEl) applyValueToElement(powerEl, okaun.power);
                    if (toughnessEl) applyValueToElement(toughnessEl, okaun.toughness);
                }
            });
            
            // Update carousel navigation
            updateCarouselNavigation();
        }

        function updateCarouselNavigation() {
            const numOkauns = state.okauns.length;
            const currentIndex = state.currentOkaunIndex;
            
            // Show/hide navigation arrows
            els.okaunNavLeft.classList.toggle('visible', currentIndex > 0 && numOkauns > 0);
            els.okaunNavRight.classList.toggle('visible', currentIndex < numOkauns - 1 && numOkauns > 0);
            
            // Show/hide number indicator
            els.okaunNumberIndicator.classList.toggle('visible', numOkauns > 1);
            if (numOkauns > 0) {
                els.okaunNumberIndicator.textContent = '#' + (currentIndex + 1);
            }
            
            // Update carousel position
            if (numOkauns > 0) {
                els.okaunCarouselTrack.style.transform = `translateX(-${currentIndex * 100}%)`;
            }
            
            // Update options count display
            els.okaunCountNum.textContent = '\u00D7' + numOkauns;
        }

        function getCurrentOkaun() {
            if (state.okauns.length === 0) return null;
            return state.okauns[state.currentOkaunIndex];
        }

        function applyWinBonus() {
            if (!state.okaunActive) return;
            
            // Apply to ALL Okauns
            state.okauns.forEach(okaun => {
                // Apply +X/+X first if active for this Okaun
                if (okaun.plusXActive) {
                    okaun.power = okaun.power + okaun.plusXPower;
                    okaun.toughness = okaun.toughness + okaun.plusXToughness;
                }
                
                // Then double
                okaun.power = okaun.power * 2n;
                okaun.toughness = okaun.toughness * 2n;
            });
            
            updateOkaunDisplay();
        }

        function addOkaunSlide(index) {
            const slideHtml = `
                <div class="okaun-slide" data-okaun-index="${index}">
                    <div class="okaun-values">
                        <div class="okaun-input-wrapper">
                            <div class="okaun-input" data-field="power" contenteditable="true">3</div>
                            <div class="okaun-arrows">
                                <button class="okaun-arrow" data-action="power-up"></button>
                                <button class="okaun-arrow" data-action="power-down"></button>
                            </div>
                        </div>
                        <span class="okaun-divider">/</span>
                        <div class="okaun-input-wrapper">
                            <div class="okaun-input" data-field="toughness" contenteditable="true">3</div>
                            <div class="okaun-arrows">
                                <button class="okaun-arrow" data-action="toughness-up"></button>
                                <button class="okaun-arrow" data-action="toughness-down"></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            els.okaunCarouselTrack.insertAdjacentHTML('beforeend', slideHtml);
        }

        function removeOkaunSlide(index) {
            const slide = els.okaunCarouselTrack.querySelector(`[data-okaun-index="${index}"]`);
            if (slide) slide.remove();
        }

        function rebuildOkaunSlides() {
            els.okaunCarouselTrack.innerHTML = '';
            state.okauns.forEach((okaun, index) => {
                addOkaunSlide(index);
            });
            updateOkaunDisplay();
        }

        function speakOkaun() {
            if (state.isSpeaking) {
                window.speechSynthesis.cancel();
                state.isSpeaking = false;
                updateSpeakerIcon();
                return;
            }
            
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            
            let text;
            const okaunNum = state.okauns.length > 1 ? ` ${state.currentOkaunIndex + 1}` : '';
            if (okaun.power === okaun.toughness) {
                text = `Okaun${okaunNum}'s power and toughness are ` + numberToWords(okaun.power);
            } else {
                text = `Okaun${okaunNum}'s power is ` + numberToWords(okaun.power) + `. Okaun${okaunNum}'s toughness is ` + numberToWords(okaun.toughness);
            }
            
            if (!window.speechSynthesis) {
                return;
            }
            
            window.speechSynthesis.cancel();
            
            state.isSpeaking = true;
            updateSpeakerIcon();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            const selectedValue = state.selectedVoice;
            if (selectedValue && selectedValue.startsWith('system_')) {
                const voiceIndex = parseInt(selectedValue.replace('system_', ''));
                if (state.availableVoices[voiceIndex]) {
                    utterance.voice = state.availableVoices[voiceIndex];
                }
            }
            
            utterance.pitch = 1;
            utterance.rate = 1;
            
            utterance.onend = () => {
                state.isSpeaking = false;
                updateSpeakerIcon();
            };
            
            utterance.onerror = () => {
                state.isSpeaking = false;
                updateSpeakerIcon();
            };
            
            window.speechSynthesis.speak(utterance);
        }

        function updateSpeakerIcon() {
            if (state.isSpeaking) {
                els.speakerIcon.style.display = 'none';
                els.speakerMuteIcon.style.display = 'block';
                els.speakerBtn.classList.add('speaking');
            } else {
                els.speakerIcon.style.display = 'block';
                els.speakerMuteIcon.style.display = 'none';
                els.speakerBtn.classList.remove('speaking');
            }
        }

        function showOkaunWords() {
            state.overlayShowingPower = true;
            els.okaunOverlay.classList.add('visible');
            
            // Use setTimeout to ensure DOM is updated before measuring
            setTimeout(updateOkaunOverlay, 0);
        }

        function updateOkaunOverlay() {
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            
            const sameValues = okaun.power === okaun.toughness;
            const okaunNum = state.okauns.length > 1 ? ` ${state.currentOkaunIndex + 1}` : '';
            
            if (sameValues) {
                els.okaunOverlayLabel.textContent = `Okaun${okaunNum}'s Power and Toughness are:`;
                els.okaunOverlayText.textContent = numberToWords(okaun.power);
                els.okaunOverlayToggle.classList.remove('visible');
            } else {
                if (state.overlayShowingPower) {
                    els.okaunOverlayLabel.textContent = `Okaun${okaunNum}'s Power is:`;
                    els.okaunOverlayText.textContent = numberToWords(okaun.power);
                    els.okaunOverlayToggle.textContent = 'Toughness';
                } else {
                    els.okaunOverlayLabel.textContent = `Okaun${okaunNum}'s Toughness is:`;
                    els.okaunOverlayText.textContent = numberToWords(okaun.toughness);
                    els.okaunOverlayToggle.textContent = 'Power';
                }
                els.okaunOverlayToggle.classList.add('visible');
            }
            
            setTimeout(() => {
                fitTextToOverlay();
            }, 50);
        }

        function fitTextToOverlay() {
            const container = els.okaunOverlay.querySelector('.okaun-overlay-content');
            const textEl = els.okaunOverlayText;
            const text = textEl.textContent;
            
            const maxWidth = container.offsetWidth - 40;
            const maxHeight = container.offsetHeight - 40;
            
            let min = 5;
            let max = 500;
            let bestSize = min;
            
            while (min <= max) {
                const mid = Math.floor((min + max) / 2);
                measureCtx.font = `700 ${mid}px "Outfit", sans-serif`;
                
                const words = text.split(/\s+/);
                let estimatedLines = 1;
                let currentLineWidth = 0;
                
                words.forEach(word => {
                    const wordWidth = measureCtx.measureText(word + ' ').width;
                    if (currentLineWidth + wordWidth > maxWidth) {
                        estimatedLines++;
                        currentLineWidth = wordWidth;
                    } else {
                        currentLineWidth += wordWidth;
                    }
                });
                
                const lineHeight = mid * 1.2;
                const estimatedHeight = estimatedLines * lineHeight;
                
                if (estimatedHeight <= maxHeight && currentLineWidth <= maxWidth) {
                    bestSize = mid;
                    min = mid + 1;
                } else {
                    max = mid - 1;
                }
            }
            
            textEl.style.fontSize = bestSize + 'px';
        }

        function addToHistory(result, isKrarkFlip = false, krarkWins = 0, krarkTotal = 0) {
            const item = document.createElement('div');
            item.classList.add('history-item');
            
            if (isKrarkFlip) {
                item.classList.add('fraction');
                item.textContent = `${krarkWins}/${krarkTotal}`;
                // Color based on wins: green if any wins, red if zero wins
                item.classList.add(krarkWins > 0 ? 'win' : 'loss');
            } else {
                item.classList.add(result ? 'win' : 'loss');
                item.textContent = result ? '' : '';
            }
            
            // Remove latest and sparkle classes from previous items in history array
            state.history = state.history.map(h => h.replace(/\blatest\b/g, '').replace(/\bsparkle\b/g, '').replace(/\s+"/g, '"').replace(/class="\s+/g, 'class="'));
            
            // Mark this as the latest item with sparkle
            item.classList.add('latest', 'sparkle');
            
            state.history.push(item.outerHTML);
            if (state.history.length > 10) {
                state.history.shift();
            }
            
            renderHistory();
            
            // Remove sparkle class after animation completes
            setTimeout(() => {
                const latestEl = els.historyBar.querySelector('.history-item.latest');
                if (latestEl) {
                    latestEl.classList.remove('sparkle');
                }
            }, 400);
        }

        function renderHistory() {
            els.historyBar.innerHTML = state.history.join('');
        }

        function updateStats(isWin) {
            if (isWin) {
                state.stats.wins++;
                state.stats.currentWinStreak++;
                state.stats.currentLossStreak = 0;
                if (state.stats.currentWinStreak > state.stats.longestWinStreak) {
                    state.stats.longestWinStreak = state.stats.currentWinStreak;
                }
            } else {
                state.stats.losses++;
                state.stats.currentLossStreak++;
                state.stats.currentWinStreak = 0;
                if (state.stats.currentLossStreak > state.stats.longestLossStreak) {
                    state.stats.longestLossStreak = state.stats.currentLossStreak;
                }
            }
        }

        function showResult(text, isWin, animate = true) {
            els.resultDisplay.textContent = text;
            els.resultDisplay.classList.remove('win', 'loss', 'animate');
            
            if (isWin !== null) {
                els.resultDisplay.classList.add(isWin ? 'win' : 'loss');
            }
            
            if (animate) {
                void els.resultDisplay.offsetWidth;
                els.resultDisplay.classList.add('animate');
            }
        }

        function getResultText(isWin) {
            if (state.htActive) {
                if (state.htMode === 'heads') {
                    return isWin ? 'HEADS' : 'TAILS';
                } else {
                    return isWin ? 'TAILS' : 'HEADS';
                }
            }
            return isWin ? 'WIN' : 'LOSS';
        }

        function performSingleFlip() {
            if (state.krarkActive) {
                const totalCoins = Math.pow(2, state.krarkCount);
                let wins = 0;
                
                for (let i = 0; i < totalCoins; i++) {
                    if (flipCoin()) wins++;
                }
                
                const isWin = wins > 0;
                addToHistory(isWin, true, wins, totalCoins);
                updateStats(isWin);
                
                return isWin;
            } else {
                const isWin = flipCoin();
                addToHistory(isWin);
                updateStats(isWin);
                return isWin;
            }
        }

        function calculateDelay(totalFlips, baseDelay = 500) {
            const maxTime = 10000;
            const totalTime = totalFlips * baseDelay;
            
            if (totalTime <= maxTime) {
                return baseDelay;
            }
            
            return maxTime / totalFlips;
        }

        async function doFlip() {
            if (state.isFlipping) {
                state.stopRequested = true;
                return;
            }
            
            // Save pre-flip state to undo stack (including history and result display)
            state.undoStack.push({
                okauns: state.okaunActive && state.okauns.length > 0 ? 
                    state.okauns.map(o => ({
                        power: o.power,
                        toughness: o.toughness
                    })) : null,
                history: [...state.history],
                resultText: els.resultDisplay.textContent,
                resultIsWin: els.resultDisplay.classList.contains('win') ? true : 
                             els.resultDisplay.classList.contains('loss') ? false : null
            });
            // Limit undo stack to 50 entries
            if (state.undoStack.length > 50) {
                state.undoStack.shift();
            }
            
            state.isFlipping = true;
            state.stopRequested = false;
            
            const isUntilLoss = state.untilLossActive;
            const isUntil2Losses = state.until2LossesActive;
            const isMultiCoins = state.coinsActive;
            
            if (isUntilLoss || isUntil2Losses) {
                els.flipBtn.textContent = 'STOP?';
                els.flipBtn.classList.add('stop-mode');
                
                let lossCount = 0;
                const lossTarget = isUntil2Losses ? 2 : 1;
                let flipCount = 0;
                let winCount = 0;
                let delay = 500;
                const minDelay = 50;
                const maxFlips = isMultiCoins ? parseInt(state.coinsCount) || 5 : Infinity;
                
                while (lossCount < lossTarget && flipCount < maxFlips && !state.stopRequested) {
                    const isWin = performSingleFlip();
                    flipCount++;
                    
                    if (isWin) {
                        winCount++;
                        applyWinBonus();
                        showResult(getResultText(true), true);
                    } else {
                        lossCount++;
                        showResult(getResultText(false), false);
                    }
                    
                    if (flipCount < maxFlips && lossCount < lossTarget && !state.stopRequested) {
                        await sleep(delay);
                        delay = Math.max(minDelay, delay * 0.85);
                    }
                }
                
                // Always show final summary for until loss/until 2 losses modes
                showResult(`${winCount}/${flipCount} WINS`, winCount > 0);
                
            } else if (isMultiCoins) {
                const totalCoins = parseInt(state.coinsCount) || 5;
                const delay = calculateDelay(totalCoins);
                let winCount = 0;
                
                els.flipBtn.classList.add('flipping');
                
                for (let i = 0; i < totalCoins; i++) {
                    const isWin = performSingleFlip();
                    
                    if (isWin) {
                        winCount++;
                        applyWinBonus();
                    }
                    
                    showResult(`${winCount}/${i + 1} Wins`, winCount > 0);
                    
                    if (i < totalCoins - 1) {
                        await sleep(delay);
                    }
                }
                
                showResult(`${winCount}/${totalCoins} Wins`, winCount > 0);
                
            } else {
                const isWin = performSingleFlip();
                
                if (isWin) {
                    applyWinBonus();
                }
                
                showResult(getResultText(isWin), isWin);
            }
            
            els.flipBtn.textContent = 'FLIP';
            els.flipBtn.classList.remove('flipping', 'stop-mode');
            state.isFlipping = false;
            state.stopRequested = false;
            
            // Enable undo button if there's something to undo
            if (state.undoStack.length > 0) {
                state.canUndo = true;
                els.undoFlipBtn.classList.add('has-undo');
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function parseOkaunValue(text) {
            const cleaned = text.replace(/,/g, '').replace(/\s/g, '').trim();
            
            if (cleaned.includes('e') || cleaned.includes('E')) {
                const num = parseFloat(cleaned);
                if (isNaN(num) || num < 0) return 3n;
                try {
                    return BigInt(Math.floor(num));
                } catch {
                    return 3n;
                }
            }
            
            const digitsOnly = cleaned.replace(/[^0-9]/g, '');
            if (!digitsOnly || digitsOnly === '0') return 3n;
            
            try {
                return BigInt(digitsOnly);
            } catch {
                return 3n;
            }
        }

        function updateToggleButtonText() {
            els.untilLoss.textContent = state.untilLossActive ? 'Until Loss!' : 'Until Loss?';
            els.until2Losses.textContent = state.until2LossesActive ? 'Until 2 Losses!' : 'Until 2 Losses?';
            els.coinsBtn.textContent = state.coinsActive ? 'Coins!' : 'Coins?';
        }

        // Event Listeners - Okaun Carousel
        
        // Delegate events for dynamic okaun inputs and arrows
        els.okaunCarouselTrack.addEventListener('blur', (e) => {
            if (!state.okaunActive) return;
            if (e.target.classList.contains('okaun-input')) {
                const field = e.target.dataset.field;
                const slide = e.target.closest('.okaun-slide');
                const index = parseInt(slide.dataset.okaunIndex);
                const val = parseOkaunValue(e.target.textContent);
                
                if (field === 'power') {
                    state.okauns[index].power = val;
                    state.okauns[index].basePower = val;
                } else {
                    state.okauns[index].toughness = val;
                    state.okauns[index].baseToughness = val;
                }
                updateOkaunDisplay();
            }
        }, true);

        els.okaunCarouselTrack.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('okaun-input') && e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        });

        els.okaunCarouselTrack.addEventListener('focus', (e) => {
            if (!state.okaunActive && e.target.classList.contains('okaun-input')) {
                e.preventDefault();
                e.target.blur();
            }
        }, true);

        els.okaunCarouselTrack.addEventListener('click', (e) => {
            if (e.target.classList.contains('okaun-arrow')) {
                e.stopPropagation();
                const action = e.target.dataset.action;
                const slide = e.target.closest('.okaun-slide');
                const index = parseInt(slide.dataset.okaunIndex);
                const okaun = state.okauns[index];
                
                if (action === 'power-up') {
                    okaun.power = okaun.power + 1n;
                    okaun.basePower = okaun.power;
                } else if (action === 'power-down' && okaun.power > 0n) {
                    okaun.power = okaun.power - 1n;
                    okaun.basePower = okaun.power;
                } else if (action === 'toughness-up') {
                    okaun.toughness = okaun.toughness + 1n;
                    okaun.baseToughness = okaun.toughness;
                } else if (action === 'toughness-down' && okaun.toughness > 0n) {
                    okaun.toughness = okaun.toughness - 1n;
                    okaun.baseToughness = okaun.toughness;
                }
                updateOkaunDisplay();
            }
        });

        // Carousel navigation
        els.okaunNavLeft.addEventListener('click', () => {
            if (state.currentOkaunIndex > 0) {
                state.currentOkaunIndex--;
                updateCarouselNavigation();
            }
        });

        els.okaunNavRight.addEventListener('click', () => {
            if (state.currentOkaunIndex < state.okauns.length - 1) {
                state.currentOkaunIndex++;
                updateCarouselNavigation();
            }
        });

        
        els.endTurn.addEventListener('click', () => {
            // Reset ALL Okauns to their individual bases
            state.okauns.forEach(okaun => {
                okaun.power = okaun.basePower;
                okaun.toughness = okaun.baseToughness;
            });
            updateOkaunDisplay();
            // Reset results display to blank
            showResult('', null, false);
            // Clear flip history
            state.history = [];
            renderHistory();
            // Clear undo state
            state.undoStack = [];
            state.canUndo = false;
            els.undoFlipBtn.classList.remove('has-undo');
        });
        
        function toggleOkaun(expand) {
            state.okaunActive = expand;
            els.okaunPanel.classList.toggle('collapsed', !expand);
            els.resultPanel.classList.toggle('expanded', !expand);
            if (expand) {
                // If expanding from 0 Okauns, create the first one
                if (state.okauns.length === 0) {
                    state.okauns = [{
                        power: 3n,
                        toughness: 3n,
                        basePower: 3n,
                        baseToughness: 3n,
                        plusXActive: false,
                        plusXPower: 1n,
                        plusXToughness: 1n
                    }];
                    state.currentOkaunIndex = 0;
                    rebuildOkaunSlides();
                    els.okaunCountNum.textContent = '\u00D71';
                    updateCarouselNavigation();
                }
                updateOkaunDisplay();
            } else {
                // Note: Don't clear undo state when collapsing Okaun panel
                // since undo now works independently of Okaun
            }
        }

        els.okaunToggle.addEventListener('click', () => {
            toggleOkaun(true);
        });

        els.okaunCollapse.addEventListener('click', () => {
            toggleOkaun(false);
        });

        // Okaun Options Modal
        function openOkaunOptions() {
            els.okaunOptionsModal.classList.add('visible');
            // Update the +X/+X display for current Okaun
            const okaun = getCurrentOkaun();
            if (okaun) {
                els.okaunPlusXSwitch.classList.toggle('active', okaun.plusXActive);
                els.okaunPlusXInputs.classList.toggle('visible', okaun.plusXActive);
                els.okaunPlusXPowerNum.textContent = okaun.plusXPower.toString();
                els.okaunPlusXToughnessNum.textContent = okaun.plusXToughness.toString();
            }
            els.okaunCountNum.textContent = '\u00D7' + state.okauns.length;
            
            // Update reset button text based on Okaun count
            if (state.okauns.length === 1) {
                els.resetThisOkaun.textContent = 'Reset Okaun';
                els.resetAllOkauns.style.display = 'none';
            } else {
                els.resetThisOkaun.textContent = 'Reset This Okaun';
                els.resetAllOkauns.style.display = '';
            }
        }

        function closeOkaunOptions() {
            els.okaunOptionsModal.classList.remove('visible');
        }

        els.okaunOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openOkaunOptions();
        });

        els.okaunOptionsModal.addEventListener('click', (e) => {
            if (e.target === els.okaunOptionsModal) {
                closeOkaunOptions();
            }
        });

        // Okaun count up/down
        els.okaunCountUp.addEventListener('click', (e) => {
            e.stopPropagation();
            // Add a new Okaun
            state.okauns.push({
                power: 3n,
                toughness: 3n,
                basePower: 3n,
                baseToughness: 3n,
                plusXActive: false,
                plusXPower: 1n,
                plusXToughness: 1n
            });
            // If adding first Okaun, set index to 0
            if (state.okauns.length === 1) {
                state.currentOkaunIndex = 0;
            }
            addOkaunSlide(state.okauns.length - 1);
            els.okaunCountNum.textContent = '\u00D7' + state.okauns.length;
            updateCarouselNavigation();
            updateOkaunDisplay();
        });

        els.okaunCountDown.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.okauns.length <= 0) return;
            
            // If going from 1 to 0, show "Remove The Last Okaun?" modal
            if (state.okauns.length === 1) {
                if (state.removeOkaunConfirmDisabled) {
                    // Remove without confirmation and toggle off
                    toggleOkaunOff();
                } else {
                    // Show "Remove The Last Okaun?" confirmation
                    els.removeLastOkaunConfirm.classList.add('visible');
                }
            } else {
                // Removing one of multiple Okauns
                if (state.removeOkaunConfirmDisabled) {
                    // Remove without confirmation
                    removeLastOkaun();
                } else {
                    // Show confirmation
                    els.removeOkaunConfirm.classList.add('visible');
                }
            }
        });

        function removeLastOkaun() {
            const lastIndex = state.okauns.length - 1;
            state.okauns.pop();
            removeOkaunSlide(lastIndex);
            if (state.currentOkaunIndex >= state.okauns.length) {
                state.currentOkaunIndex = Math.max(0, state.okauns.length - 1);
            }
            els.okaunCountNum.textContent = '\u00D7' + state.okauns.length;
            updateCarouselNavigation();
        }

        function toggleOkaunOff() {
            // Close options modal first
            closeOkaunOptions();
            // Set count to 0
            state.okauns = [];
            els.okaunCarouselTrack.innerHTML = '';
            state.currentOkaunIndex = 0;
            els.okaunCountNum.textContent = '\u00D70';
            updateCarouselNavigation();
            // Then collapse the panel
            toggleOkaun(false);
        }

        els.removeOkaunYes.addEventListener('click', () => {
            els.removeOkaunConfirm.classList.remove('visible');
            removeLastOkaun();
        });

        els.removeOkaunDontAsk.addEventListener('click', () => {
            els.removeOkaunConfirm.classList.remove('visible');
            state.removeOkaunConfirmDisabled = true;
            removeLastOkaun();
        });

        els.removeOkaunNo.addEventListener('click', () => {
            els.removeOkaunConfirm.classList.remove('visible');
        });

        els.removeLastOkaunYes.addEventListener('click', () => {
            els.removeLastOkaunConfirm.classList.remove('visible');
            toggleOkaunOff();
        });

        els.removeLastOkaunDontAsk.addEventListener('click', () => {
            els.removeLastOkaunConfirm.classList.remove('visible');
            state.removeOkaunConfirmDisabled = true;
            toggleOkaunOff();
        });

        els.removeLastOkaunNo.addEventListener('click', () => {
            els.removeLastOkaunConfirm.classList.remove('visible');
        });

        // +X/+X toggle for current Okaun
        els.okaunPlusXSwitch.addEventListener('click', (e) => {
            e.stopPropagation();
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            okaun.plusXActive = !okaun.plusXActive;
            els.okaunPlusXSwitch.classList.toggle('active', okaun.plusXActive);
            els.okaunPlusXInputs.classList.toggle('visible', okaun.plusXActive);
        });

        // +X/+X arrow buttons
        els.okaunPlusXPowerUp.addEventListener('click', (e) => {
            e.stopPropagation();
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            const val = parseInt(els.okaunPlusXPowerNum.textContent) || 0;
            okaun.plusXPower = BigInt(val + 1);
            els.okaunPlusXPowerNum.textContent = (val + 1).toString();
        });

        els.okaunPlusXPowerDown.addEventListener('click', (e) => {
            e.stopPropagation();
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            const val = parseInt(els.okaunPlusXPowerNum.textContent) || 0;
            if (val > 0) {
                okaun.plusXPower = BigInt(val - 1);
                els.okaunPlusXPowerNum.textContent = (val - 1).toString();
            }
        });

        els.okaunPlusXToughnessUp.addEventListener('click', (e) => {
            e.stopPropagation();
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            const val = parseInt(els.okaunPlusXToughnessNum.textContent) || 0;
            okaun.plusXToughness = BigInt(val + 1);
            els.okaunPlusXToughnessNum.textContent = (val + 1).toString();
        });

        els.okaunPlusXToughnessDown.addEventListener('click', (e) => {
            e.stopPropagation();
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            const val = parseInt(els.okaunPlusXToughnessNum.textContent) || 0;
            if (val > 0) {
                okaun.plusXToughness = BigInt(val - 1);
                els.okaunPlusXToughnessNum.textContent = (val - 1).toString();
            }
        });

        // Reset this Okaun
        els.resetThisOkaun.addEventListener('click', () => {
            const okaun = getCurrentOkaun();
            if (!okaun) return;
            okaun.power = 3n;
            okaun.toughness = 3n;
            okaun.basePower = 3n;
            okaun.baseToughness = 3n;
            updateOkaunDisplay();
            closeOkaunOptions();
        });

        // Reset ALL Okauns
        els.resetAllOkauns.addEventListener('click', () => {
            els.resetAllConfirm.classList.add('visible');
        });

        els.resetAllYes.addEventListener('click', () => {
            state.okauns.forEach(okaun => {
                okaun.power = 3n;
                okaun.toughness = 3n;
                okaun.basePower = 3n;
                okaun.baseToughness = 3n;
            });
            updateOkaunDisplay();
            els.resetAllConfirm.classList.remove('visible');
            closeOkaunOptions();
        });

        els.resetAllNo.addEventListener('click', () => {
            els.resetAllConfirm.classList.remove('visible');
        });
        
        els.speakerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            speakOkaun();
        });
        
        els.eyeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showOkaunWords();
        });
        
        els.okaunOverlayToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            state.overlayShowingPower = !state.overlayShowingPower;
            updateOkaunOverlay();
        });
        
        els.okaunOverlay.addEventListener('click', (e) => {
            if (e.target !== els.okaunOverlayToggle) {
                els.okaunOverlay.classList.remove('visible');
            }
        });
        
        function updateKrarkText() {
            if (state.krarkActive) {
                els.krarkText.textContent = state.krarkCount > 1 ? "KRARK'S THUMBS!" : "KRARK'S THUMB!";
            } else {
                els.krarkText.textContent = "Krark's Thumb?";
            }
        }
        
        els.krarkToggle.addEventListener('click', (e) => {
            if (e.target.closest('.krark-arrows')) return;
            
            state.krarkActive = !state.krarkActive;
            els.krarkToggle.classList.toggle('active', state.krarkActive);
            updateKrarkText();
        });
        
        els.krarkUp.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.krarkCount >= 8) {
                els.krarkNum.classList.add('flash-red');
                setTimeout(() => els.krarkNum.classList.remove('flash-red'), 300);
                return;
            }
            state.krarkCount++;
            els.krarkNum.textContent = state.krarkCount;
            updateKrarkText();
        });
        
        els.krarkDown.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.krarkCount > 1) {
                state.krarkCount--;
                els.krarkNum.textContent = state.krarkCount;
                updateKrarkText();
            }
        });
        
        els.flipBtn.addEventListener('click', doFlip);
        
        els.untilLoss.addEventListener('click', () => {
            state.untilLossActive = !state.untilLossActive;
            if (state.untilLossActive) {
                state.until2LossesActive = false;
                els.until2Losses.classList.remove('active');
            }
            els.untilLoss.classList.toggle('active', state.untilLossActive);
            updateToggleButtonText();
        });
        
        els.until2Losses.addEventListener('click', () => {
            state.until2LossesActive = !state.until2LossesActive;
            if (state.until2LossesActive) {
                state.untilLossActive = false;
                els.untilLoss.classList.remove('active');
            }
            els.until2Losses.classList.toggle('active', state.until2LossesActive);
            updateToggleButtonText();
        });
        
        els.coinsBtn.addEventListener('click', () => {
            state.coinsActive = !state.coinsActive;
            els.coinsBtn.classList.toggle('active', state.coinsActive);
            els.coinsToggle.classList.toggle('active', state.coinsActive);
            updateToggleButtonText();
        });
        
        // Coins arrows with hold-to-accelerate
        let coinsHoldInterval = null;
        let coinsHoldTimeout = null;
        let coinsHoldDelay = 300;
        
        function updateCoinsDisplay() {
            els.coinsNum.value = state.coinsCount;
        }
        
        function incrementCoins() {
            if (state.coinsCount >= 999) {
                els.coinsNum.classList.add('flash-red');
                setTimeout(() => els.coinsNum.classList.remove('flash-red'), 300);
                return false;
            }
            state.coinsCount++;
            updateCoinsDisplay();
            return true;
        }
        
        function decrementCoins() {
            if (state.coinsCount <= 1) {
                els.coinsNum.classList.add('flash-red');
                setTimeout(() => els.coinsNum.classList.remove('flash-red'), 300);
                return false;
            }
            state.coinsCount--;
            updateCoinsDisplay();
            return true;
        }
        
        function startCoinsHold(action) {
            coinsHoldDelay = 300;
            const doAction = action === 'up' ? incrementCoins : decrementCoins;
            
            coinsHoldTimeout = setTimeout(function repeat() {
                if (doAction()) {
                    coinsHoldDelay = Math.max(30, coinsHoldDelay * 0.8);
                    coinsHoldInterval = setTimeout(repeat, coinsHoldDelay);
                }
            }, coinsHoldDelay);
        }
        
        function stopCoinsHold() {
            clearTimeout(coinsHoldTimeout);
            clearTimeout(coinsHoldInterval);
            coinsHoldTimeout = null;
            coinsHoldInterval = null;
        }
        
        els.coinsUp.addEventListener('click', incrementCoins);
        els.coinsDown.addEventListener('click', decrementCoins);
        
        els.coinsUp.addEventListener('mousedown', () => startCoinsHold('up'));
        els.coinsUp.addEventListener('mouseup', stopCoinsHold);
        els.coinsUp.addEventListener('mouseleave', stopCoinsHold);
        els.coinsUp.addEventListener('touchstart', (e) => { e.preventDefault(); incrementCoins(); startCoinsHold('up'); });
        els.coinsUp.addEventListener('touchend', stopCoinsHold);
        
        els.coinsDown.addEventListener('mousedown', () => startCoinsHold('down'));
        els.coinsDown.addEventListener('mouseup', stopCoinsHold);
        els.coinsDown.addEventListener('mouseleave', stopCoinsHold);
        els.coinsDown.addEventListener('touchstart', (e) => { e.preventDefault(); decrementCoins(); startCoinsHold('down'); });
        els.coinsDown.addEventListener('touchend', stopCoinsHold);
        
        // Manual input for coins
        els.coinsNum.addEventListener('change', () => {
            let val = parseInt(els.coinsNum.value) || 5;
            val = Math.max(1, Math.min(999, val));
            state.coinsCount = val;
            updateCoinsDisplay();
        });
        
        els.coinsNum.addEventListener('blur', () => {
            let val = parseInt(els.coinsNum.value) || 5;
            val = Math.max(1, Math.min(999, val));
            state.coinsCount = val;
            updateCoinsDisplay();
        });
        
        // Undo flip button
        els.undoFlipBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (!state.canUndo || state.undoStack.length === 0) return;
            
            // Pop the last state from the undo stack
            const previousState = state.undoStack.pop();
            
            // Restore pre-flip Okaun stats if they were saved
            if (previousState.okauns) {
                state.okauns.forEach((okaun, index) => {
                    if (previousState.okauns[index]) {
                        okaun.power = previousState.okauns[index].power;
                        okaun.toughness = previousState.okauns[index].toughness;
                    }
                });
                updateOkaunDisplay();
            }
            
            // Restore history
            state.history = previousState.history;
            renderHistory();
            
            // Restore result display
            els.resultDisplay.textContent = previousState.resultText;
            els.resultDisplay.classList.remove('win', 'loss');
            if (previousState.resultIsWin === true) {
                els.resultDisplay.classList.add('win');
            } else if (previousState.resultIsWin === false) {
                els.resultDisplay.classList.add('loss');
            }
            
            // Disable undo button if no more undos available
            if (state.undoStack.length === 0) {
                state.canUndo = false;
                els.undoFlipBtn.classList.remove('has-undo');
            }
        });

        // Help button and Settings Panel
        els.helpBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = els.settingsPanel.classList.contains('visible');
            els.settingsPanel.classList.toggle('visible', !isVisible);
            els.helpBtn.classList.toggle('active', !isVisible);
            
            if (!isVisible) {
                const rect = els.helpBtn.getBoundingClientRect();
                els.settingsPanel.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                els.settingsPanel.style.left = Math.max(10, rect.left - 50) + 'px';
            }
        });

        els.settingsClose.addEventListener('click', (e) => {
            e.stopPropagation();
            els.settingsPanel.classList.remove('visible');
            els.helpBtn.classList.remove('active');
        });

        els.okaunOptionsClose.addEventListener('click', (e) => {
            e.stopPropagation();
            closeOkaunOptions();
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#helpBtn') && !e.target.closest('#settingsPanel')) {
                els.settingsPanel.classList.remove('visible');
                els.helpBtn.classList.remove('active');
            }
        });

        els.simpleModeSwitch.addEventListener('click', (e) => {
            e.stopPropagation();
            state.simpleMode = !state.simpleMode;
            els.simpleModeSwitch.classList.toggle('active', state.simpleMode);
            document.body.classList.toggle('power-save', state.simpleMode);
            document.body.classList.toggle('simple-mode', state.simpleMode);
        });

        els.voiceSelect.addEventListener('change', (e) => {
            state.selectedVoice = e.target.value;
        });

        // Track Tax toggle
        els.trackTaxSwitch.addEventListener('click', (e) => {
            e.stopPropagation();
            state.trackTaxActive = !state.trackTaxActive;
            els.trackTaxSwitch.classList.toggle('active', state.trackTaxActive);
            els.trackTaxOptionsRow.style.display = state.trackTaxActive ? 'flex' : 'none';
            if (!state.trackTaxActive) {
                state.trackZndrsplt = false;
                state.trackOkaun = false;
                state.trackOther = false;
                els.trackZndrspltBtn.classList.remove('active');
                els.trackOkaunBtn.classList.remove('active');
                els.trackOtherBtn.classList.remove('active');
                updateTaxCountersVisibility();
            }
        });

        function getActiveTrackCount() {
            return (state.trackZndrsplt ? 1 : 0) + (state.trackOkaun ? 1 : 0) + (state.trackOther ? 1 : 0);
        }

        function flashTrackBtn(btn) {
            btn.classList.add('flash-red');
            setTimeout(() => btn.classList.remove('flash-red'), 300);
        }

        els.trackZndrspltBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // If trying to activate and already have 2 active, flash red
            if (!state.trackZndrsplt && getActiveTrackCount() >= 2) {
                flashTrackBtn(els.trackZndrspltBtn);
                return;
            }
            state.trackZndrsplt = !state.trackZndrsplt;
            els.trackZndrspltBtn.classList.toggle('active', state.trackZndrsplt);
            updateTaxCountersVisibility();
        });

        els.trackOkaunBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // If trying to activate and already have 2 active, flash red
            if (!state.trackOkaun && getActiveTrackCount() >= 2) {
                flashTrackBtn(els.trackOkaunBtn);
                return;
            }
            state.trackOkaun = !state.trackOkaun;
            els.trackOkaunBtn.classList.toggle('active', state.trackOkaun);
            updateTaxCountersVisibility();
        });

        els.trackOtherBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            // If trying to activate and already have 2 active, flash red
            if (!state.trackOther && getActiveTrackCount() >= 2) {
                flashTrackBtn(els.trackOtherBtn);
                return;
            }
            state.trackOther = !state.trackOther;
            els.trackOtherBtn.classList.toggle('active', state.trackOther);
            updateTaxCountersVisibility();
        });

        function updateTaxCountersVisibility() {
            const showAny = state.trackZndrsplt || state.trackOkaun || state.trackOther;
            els.taxCounters.classList.toggle('visible', showAny);
            els.zndrspltCounter.style.display = state.trackZndrsplt ? 'flex' : 'none';
            els.okaunTaxCounter.style.display = state.trackOkaun ? 'flex' : 'none';
            els.otherTaxCounter.style.display = state.trackOther ? 'flex' : 'none';
        }

        // Tax counter arrows
        els.zndrspltUp.addEventListener('click', (e) => {
            e.stopPropagation();
            state.zndrspltTax += 2;
            els.zndrspltNum.textContent = '+' + state.zndrspltTax;
        });

        els.zndrspltDown.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.zndrspltTax > 0) {
                state.zndrspltTax -= 2;
                els.zndrspltNum.textContent = '+' + state.zndrspltTax;
            } else {
                els.zndrspltNum.classList.add('flash-red');
                setTimeout(() => els.zndrspltNum.classList.remove('flash-red'), 300);
            }
        });

        els.okaunTaxUp.addEventListener('click', (e) => {
            e.stopPropagation();
            state.okaunTax += 2;
            els.okaunTaxNum.textContent = '+' + state.okaunTax;
        });

        els.okaunTaxDown.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.okaunTax > 0) {
                state.okaunTax -= 2;
                els.okaunTaxNum.textContent = '+' + state.okaunTax;
            } else {
                els.okaunTaxNum.classList.add('flash-red');
                setTimeout(() => els.okaunTaxNum.classList.remove('flash-red'), 300);
            }
        });

        els.otherTaxUp.addEventListener('click', (e) => {
            e.stopPropagation();
            state.otherTax += 2;
            els.otherTaxNum.textContent = '+' + state.otherTax;
        });

        els.otherTaxDown.addEventListener('click', (e) => {
            e.stopPropagation();
            if (state.otherTax > 0) {
                state.otherTax -= 2;
                els.otherTaxNum.textContent = '+' + state.otherTax;
            } else {
                els.otherTaxNum.classList.add('flash-red');
                setTimeout(() => els.otherTaxNum.classList.remove('flash-red'), 300);
            }
        });
        
        els.statsBtn.addEventListener('click', () => {
            updateStatsDisplay();
            els.statsOverlay.classList.add('visible');
        });
        
        els.closeStats.addEventListener('click', () => {
            els.statsOverlay.classList.remove('visible');
        });
        
        els.resetStats.addEventListener('click', () => {
            state.stats = {
                wins: 0,
                losses: 0,
                longestWinStreak: 0,
                longestLossStreak: 0,
                currentWinStreak: 0,
                currentLossStreak: 0
            };
            updateStatsDisplay();
        });
        
        els.statsOverlay.addEventListener('click', (e) => {
            if (e.target === els.statsOverlay) {
                els.statsOverlay.classList.remove('visible');
            }
        });
        
        function updateStatsDisplay() {
            const total = state.stats.wins + state.stats.losses;
            const winRate = total > 0 ? ((state.stats.wins / total) * 100).toFixed(1) : 0;
            
            els.statWins.textContent = state.stats.wins;
            els.statLosses.textContent = state.stats.losses;
            els.statWinRate.textContent = winRate + '%';
            els.statTotal.textContent = total;
            els.statWinStreak.textContent = state.stats.longestWinStreak;
            els.statLossStreak.textContent = state.stats.longestLossStreak;
        }
        
        els.htBtn.addEventListener('click', () => {
            state.htActive = !state.htActive;
            els.htContainer.classList.toggle('active', state.htActive);
            els.htBtn.classList.toggle('active', state.htActive);
            updateHTButtonText();
        });
        
        els.htHeads.addEventListener('click', () => {
            state.htMode = 'heads';
            els.htHeads.classList.add('selected');
            els.htTails.classList.remove('selected');
            updateHTButtonText();
        });
        
        els.htTails.addEventListener('click', () => {
            state.htMode = 'tails';
            els.htTails.classList.add('selected');
            els.htHeads.classList.remove('selected');
            updateHTButtonText();
        });
        
        function updateHTButtonText() {
            // HT button doesn't have a help bubble inside it, but htContainer does
            if (state.htActive) {
                els.htBtn.textContent = state.htMode === 'heads' ? 'Heads Mode!' : 'Tails Mode!';
            } else {
                els.htBtn.textContent = 'Heads/Tails Mode?';
            }
        }
        
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                // Only prevent zoom on non-interactive elements (background areas)
                // Interactive elements handle this via CSS touch-action: manipulation
                const interactive = e.target.closest('button, input, select, textarea, a, [role="button"], .btn, .settings-switch, .toggle-btn, .close-btn, .okaun-btn, .okaun-icon-btn, .confirm-btn, .flip-btn-container, .undo-flip-btn, .coins-control, .voltron-control, .ench-control, .ench-btn, .card-btn, .settings-panel-title, .ench-settings-title');
                if (!interactive) {
                    e.preventDefault();
                }
            }
            lastTouchEnd = now;
        }, false);
        
        window.addEventListener('resize', () => {
            updateOkaunDisplay();
            if (els.okaunOverlay.classList.contains('visible')) {
                fitTextToOverlay();
            }
        });
        
        // Initialize
        updateOkaunDisplay();
        updateCarouselNavigation();
        updateToggleButtonText();

        // ========== ENCHANTMENT MODE ==========
        
        // Enchantment State
        const enchState = {
            commanderTax: 0,
            field: 0,
            control: 0,
            auras: 0
        };

        // Enchantment Elements
        const enchEls = {
            container: document.getElementById('enchantmentContainer'),
            fieldValue: document.getElementById('enchFieldValue'),
            fieldUp: document.getElementById('enchFieldUp'),
            fieldDown: document.getElementById('enchFieldDown'),
            fieldReset: document.getElementById('enchFieldReset'),
            controlValue: document.getElementById('enchControlValue'),
            controlUp: document.getElementById('enchControlUp'),
            controlDown: document.getElementById('enchControlDown'),
            controlReset: document.getElementById('enchControlReset'),
            aurasValue: document.getElementById('enchAurasValue'),
            aurasUp: document.getElementById('enchAurasUp'),
            aurasDown: document.getElementById('enchAurasDown'),
            aurasReset: document.getElementById('enchAurasReset'),
            commanderTaxValue: document.getElementById('enchCommanderTaxValue'),
            commanderTaxUp: document.getElementById('enchCommanderTaxUp'),
            commanderTaxDown: document.getElementById('enchCommanderTaxDown'),
            resetAll: document.getElementById('enchResetAll'),
            extrasBtn: document.getElementById('enchExtrasBtn'),
            settingsPanel: document.getElementById('enchSettingsPanel'),
            settingsClose: document.getElementById('enchSettingsClose'),
            returnBtn: document.getElementById('enchReturnBtn'),
            settingsPanelTitle: document.getElementById('settingsPanelTitle')
        };

        // Triple-tap detection for SETTINGS title
        let settingsTapCount = 0;
        let settingsTapTimeout = null;

        // Handler will be set up after voltron elements are defined

        function switchToEnchantmentMode() {
            // Close settings panel
            els.settingsPanel.classList.remove('visible');
            els.helpBtn.classList.remove('active');
            // Switch to enchantment mode
            document.body.classList.add('enchantment-mode');
        }

        function switchToCoinflipMode() {
            // Close enchantment settings panel
            enchEls.settingsPanel.classList.remove('visible');
            // Switch back to coinflip mode
            document.body.classList.remove('enchantment-mode');
        }

        // Enchantment update functions
        function updateEnchCommanderTax() {
            enchEls.commanderTaxValue.textContent = '+' + enchState.commanderTax;
        }

        function updateEnchField() {
            enchEls.fieldValue.textContent = enchState.field;
        }

        function updateEnchControl() {
            enchEls.controlValue.textContent = enchState.control;
        }

        function updateEnchAuras() {
            enchEls.aurasValue.textContent = enchState.auras;
        }

        function enchFlashElement(el) {
            el.classList.add('ench-flash-red');
            setTimeout(() => el.classList.remove('ench-flash-red'), 300);
        }

        function enchShakeElement(el) {
            el.classList.add('ench-shake');
            el.classList.add('ench-flash-red');
            setTimeout(() => {
                el.classList.remove('ench-shake');
                el.classList.remove('ench-flash-red');
            }, 400);
        }

        // Enchantment Commander Tax handlers
        enchEls.commanderTaxUp.addEventListener('click', () => {
            enchState.commanderTax += 2;
            updateEnchCommanderTax();
        });

        enchEls.commanderTaxDown.addEventListener('click', () => {
            if (enchState.commanderTax >= 2) {
                enchState.commanderTax -= 2;
                updateEnchCommanderTax();
            } else if (enchState.commanderTax === 1) {
                enchState.commanderTax = 0;
                updateEnchCommanderTax();
            } else {
                enchFlashElement(enchEls.commanderTaxValue);
            }
        });

        // Field handlers
        enchEls.fieldUp.addEventListener('click', () => {
            enchState.field += 1;
            updateEnchField();
        });

        enchEls.fieldDown.addEventListener('click', () => {
            if (enchState.field > enchState.control) {
                enchState.field -= 1;
                updateEnchField();
            } else {
                enchFlashElement(enchEls.fieldValue);
            }
        });

        enchEls.fieldReset.addEventListener('click', () => {
            enchState.field = 0;
            enchState.control = 0;
            enchState.auras = 0;
            updateEnchField();
            updateEnchControl();
            updateEnchAuras();
        });

        // Control handlers
        enchEls.controlUp.addEventListener('click', () => {
            enchState.control += 1;
            enchState.field += 1;
            updateEnchControl();
            updateEnchField();
        });

        enchEls.controlDown.addEventListener('click', () => {
            if (enchState.control > enchState.auras) {
                enchState.control -= 1;
                enchState.field = Math.max(0, enchState.field - 1);
                updateEnchControl();
                updateEnchField();
            } else {
                enchFlashElement(enchEls.controlValue);
            }
        });

        enchEls.controlReset.addEventListener('click', () => {
            enchState.field = Math.max(0, enchState.field - enchState.control);
            enchState.control = 0;
            enchState.auras = 0;
            updateEnchControl();
            updateEnchField();
            updateEnchAuras();
        });

        // Auras handlers
        enchEls.aurasUp.addEventListener('click', () => {
            enchState.auras += 1;
            enchState.control += 1;
            enchState.field += 1;
            updateEnchAuras();
            updateEnchControl();
            updateEnchField();
        });

        enchEls.aurasDown.addEventListener('click', () => {
            if (enchState.auras > 0) {
                enchState.auras -= 1;
                enchState.control = Math.max(0, enchState.control - 1);
                enchState.field = Math.max(0, enchState.field - 1);
                updateEnchAuras();
                updateEnchControl();
                updateEnchField();
            } else {
                enchFlashElement(enchEls.aurasValue);
            }
        });

        enchEls.aurasReset.addEventListener('click', () => {
            enchState.control = Math.max(0, enchState.control - enchState.auras);
            enchState.field = Math.max(0, enchState.field - enchState.auras);
            enchState.auras = 0;
            updateEnchAuras();
            updateEnchControl();
            updateEnchField();
        });

        // Reset All
        enchEls.resetAll.addEventListener('click', () => {
            enchState.commanderTax = 0;
            enchState.field = 0;
            enchState.control = 0;
            enchState.auras = 0;
            updateEnchCommanderTax();
            updateEnchField();
            updateEnchControl();
            updateEnchAuras();
        });

        // Enchantment Extras button
        enchEls.extrasBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            const isVisible = enchEls.settingsPanel.classList.contains('visible');
            enchEls.settingsPanel.classList.toggle('visible', !isVisible);
            
            if (!isVisible) {
                const rect = enchEls.extrasBtn.getBoundingClientRect();
                enchEls.settingsPanel.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
                enchEls.settingsPanel.style.left = Math.max(10, rect.left - 50) + 'px';
            }
        });

        enchEls.settingsClose.addEventListener('click', (e) => {
            e.stopPropagation();
            enchEls.settingsPanel.classList.remove('visible');
        });

        enchEls.returnBtn.addEventListener('click', () => {
            switchToCoinflipMode();
        });

        // Close enchantment settings when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#enchExtrasBtn') && !e.target.closest('#enchSettingsPanel')) {
                enchEls.settingsPanel.classList.remove('visible');
            }
        });

        // Enchantment editable field handling
        function setupEnchEditableField(el, stateKey, minValueGetter, onValidIncrease) {
            let previousValue = enchState[stateKey];

            el.addEventListener('focus', () => {
                previousValue = enchState[stateKey];
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            });

            el.addEventListener('blur', () => {
                const text = el.textContent.trim();
                const newValue = parseInt(text, 10);

                if (isNaN(newValue) || newValue < 0) {
                    enchState[stateKey] = previousValue;
                    el.textContent = previousValue;
                    enchShakeElement(el);
                    return;
                }

                const minValue = minValueGetter();

                if (newValue < minValue) {
                    enchState[stateKey] = previousValue;
                    el.textContent = previousValue;
                    enchShakeElement(el);
                    return;
                }

                const difference = newValue - previousValue;
                enchState[stateKey] = newValue;

                if (difference > 0 && onValidIncrease) {
                    onValidIncrease(difference);
                }

                el.textContent = newValue;
            });

            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    el.blur();
                }
            });

            el.addEventListener('input', () => {
                const text = el.textContent;
                const cleaned = text.replace(/[^0-9]/g, '');
                if (text !== cleaned) {
                    el.textContent = cleaned;
                    const range = document.createRange();
                    range.selectNodeContents(el);
                    range.collapse(false);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            });
        }

        // Setup enchantment editable fields
        setupEnchEditableField(enchEls.fieldValue, 'field', () => enchState.control, null);
        setupEnchEditableField(enchEls.controlValue, 'control', () => enchState.auras, (diff) => {
            enchState.field += diff;
            updateEnchField();
        });
        setupEnchEditableField(enchEls.aurasValue, 'auras', () => 0, (diff) => {
            enchState.control += diff;
            enchState.field += diff;
            updateEnchControl();
            updateEnchField();
        });

        // ========== VOLTRON MODE ==========
        
        // Voltron State
        const voltronState = {
            power: 5,
            toughness: 5,
            keywords: [], // Array of { id, type, value (optional for ward/protection) }
            active: false
        };

        let voltronKeywordIdCounter = 0;

        // Keyword icons mapping
        const keywordIcons = {
            'flying': '',
            'trample': '',
            'lifelink': '',
            'pseudo-lifelink': '',
            'deathtouch': '',
            'first-strike': '',
            'double-strike': '',
            'vigilance': '',
            'haste': '',
            'hexproof': '',
            'indestructible': '',
            'menace': '',
            'reach': '',
            'shroud': '',
            'ward': '',
            'protection': ''
        };

        const keywordNames = {
            'flying': 'Flying',
            'trample': 'Trample',
            'lifelink': 'Lifelink',
            'pseudo-lifelink': 'Pseudo Lifelink',
            'deathtouch': 'Deathtouch',
            'first-strike': 'First Strike',
            'double-strike': 'Double Strike',
            'vigilance': 'Vigilance',
            'haste': 'Haste',
            'hexproof': 'Hexproof',
            'indestructible': 'Indestructible',
            'menace': 'Menace',
            'reach': 'Reach',
            'shroud': 'Shroud',
            'ward': 'Ward',
            'protection': 'Protection from'
        };

        // Voltron Elements
        const voltronEls = {
            panel: document.getElementById('voltronPanel'),
            power: document.getElementById('voltronPower'),
            powerUp: document.getElementById('voltronPowerUp'),
            powerDown: document.getElementById('voltronPowerDown'),
            toughness: document.getElementById('voltronToughness'),
            toughnessUp: document.getElementById('voltronToughnessUp'),
            toughnessDown: document.getElementById('voltronToughnessDown'),
            keywordDropdown: document.getElementById('voltronKeywordDropdown'),
            keywordsList: document.getElementById('voltronKeywordsList'),
            resetAll: document.getElementById('voltronResetAll'),
            modeSwitchModal: document.getElementById('modeSwitchModal'),
            modeSwitchConfirm: document.getElementById('modeSwitchConfirm'),
            modeSwitchCancel: document.getElementById('modeSwitchCancel'),
            enchModeSwitch: document.getElementById('enchModeSwitch'),
            voltronModeSwitch: document.getElementById('voltronModeSwitchPanel')
        };

        // Voltron Mode Toggle
        const enchantmentTitle = document.getElementById('enchantmentTitle');
        
        function toggleVoltronMode() {
            voltronState.active = !voltronState.active;
            enchEls.container.classList.toggle('voltron-active', voltronState.active);
            
            // Update title text
            if (enchantmentTitle) {
                if (voltronState.active) {
                    const isLethal = voltronState.power >= 21;
                    enchantmentTitle.textContent = isLethal ? "IT'S VOLTRON TIME" : 'VOLTRON MODE';
                    enchantmentTitle.classList.toggle('lethal', isLethal);
                } else {
                    enchantmentTitle.textContent = 'ENCHANTMENT TRACKER';
                    enchantmentTitle.classList.remove('lethal');
                }
            }
        }

        // Mode switch panel event listeners
        voltronEls.enchModeSwitch.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleVoltronMode();
        });

        voltronEls.voltronModeSwitch.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleVoltronMode();
        });

        // Voltron P/T Display
        function updateVoltronPower() {
            voltronEls.power.textContent = voltronState.power;
            // Toggle lethal animation and text when power >= 21 (only if voltron mode is active)
            const title = document.getElementById('enchantmentTitle');
            if (title && voltronState.active) {
                const isLethal = voltronState.power >= 21;
                title.classList.toggle('lethal', isLethal);
                title.textContent = isLethal ? "IT'S VOLTRON TIME" : "VOLTRON MODE";
            }
        }

        function updateVoltronToughness() {
            voltronEls.toughness.textContent = voltronState.toughness;
        }

        // Hold-to-accelerate for P/T arrows
        let voltronHoldInterval = null;
        let voltronHoldTimeout = null;
        let voltronHoldDelay = 300;

        function startVoltronHold(action) {
            voltronHoldDelay = 300;
            const doAction = action;
            
            voltronHoldTimeout = setTimeout(function repeat() {
                doAction();
                voltronHoldDelay = Math.max(30, voltronHoldDelay * 0.8);
                voltronHoldInterval = setTimeout(repeat, voltronHoldDelay);
            }, voltronHoldDelay);
        }

        function stopVoltronHold() {
            clearTimeout(voltronHoldTimeout);
            clearTimeout(voltronHoldInterval);
            voltronHoldTimeout = null;
            voltronHoldInterval = null;
        }

        function incrementVoltronPower() {
            voltronState.power++;
            updateVoltronPower();
        }

        function decrementVoltronPower() {
            if (voltronState.power > 0) {
                voltronState.power--;
                updateVoltronPower();
            } else {
                enchFlashElement(voltronEls.power);
            }
        }

        function incrementVoltronToughness() {
            voltronState.toughness++;
            updateVoltronToughness();
        }

        function decrementVoltronToughness() {
            if (voltronState.toughness > 0) {
                voltronState.toughness--;
                updateVoltronToughness();
            } else {
                enchFlashElement(voltronEls.toughness);
            }
        }

        // Power arrows
        voltronEls.powerUp.addEventListener('click', incrementVoltronPower);
        voltronEls.powerDown.addEventListener('click', decrementVoltronPower);
        
        voltronEls.powerUp.addEventListener('mousedown', () => startVoltronHold(incrementVoltronPower));
        voltronEls.powerUp.addEventListener('mouseup', stopVoltronHold);
        voltronEls.powerUp.addEventListener('mouseleave', stopVoltronHold);
        voltronEls.powerUp.addEventListener('touchstart', (e) => { e.preventDefault(); incrementVoltronPower(); startVoltronHold(incrementVoltronPower); });
        voltronEls.powerUp.addEventListener('touchend', stopVoltronHold);

        voltronEls.powerDown.addEventListener('mousedown', () => startVoltronHold(decrementVoltronPower));
        voltronEls.powerDown.addEventListener('mouseup', stopVoltronHold);
        voltronEls.powerDown.addEventListener('mouseleave', stopVoltronHold);
        voltronEls.powerDown.addEventListener('touchstart', (e) => { e.preventDefault(); decrementVoltronPower(); startVoltronHold(decrementVoltronPower); });
        voltronEls.powerDown.addEventListener('touchend', stopVoltronHold);

        // Toughness arrows
        voltronEls.toughnessUp.addEventListener('click', incrementVoltronToughness);
        voltronEls.toughnessDown.addEventListener('click', decrementVoltronToughness);
        
        voltronEls.toughnessUp.addEventListener('mousedown', () => startVoltronHold(incrementVoltronToughness));
        voltronEls.toughnessUp.addEventListener('mouseup', stopVoltronHold);
        voltronEls.toughnessUp.addEventListener('mouseleave', stopVoltronHold);
        voltronEls.toughnessUp.addEventListener('touchstart', (e) => { e.preventDefault(); incrementVoltronToughness(); startVoltronHold(incrementVoltronToughness); });
        voltronEls.toughnessUp.addEventListener('touchend', stopVoltronHold);

        voltronEls.toughnessDown.addEventListener('mousedown', () => startVoltronHold(decrementVoltronToughness));
        voltronEls.toughnessDown.addEventListener('mouseup', stopVoltronHold);
        voltronEls.toughnessDown.addEventListener('mouseleave', stopVoltronHold);
        voltronEls.toughnessDown.addEventListener('touchstart', (e) => { e.preventDefault(); decrementVoltronToughness(); startVoltronHold(decrementVoltronToughness); });
        voltronEls.toughnessDown.addEventListener('touchend', stopVoltronHold);

        // Editable P/T fields
        function setupVoltronPTField(el, stateKey) {
            el.addEventListener('focus', () => {
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            });

            el.addEventListener('blur', () => {
                const text = el.textContent.trim();
                const newValue = parseInt(text, 10);

                if (isNaN(newValue) || newValue < 0) {
                    el.textContent = voltronState[stateKey];
                    enchShakeElement(el);
                    return;
                }

                voltronState[stateKey] = newValue;
                el.textContent = newValue;
            });

            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                e.preventDefault();
                    el.blur();
                }
            });

            el.addEventListener('input', () => {
                const text = el.textContent;
                const cleaned = text.replace(/[^0-9]/g, '');
                if (text !== cleaned) {
                    el.textContent = cleaned;
                    const range = document.createRange();
                    range.selectNodeContents(el);
                    range.collapse(false);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            });
        }

        setupVoltronPTField(voltronEls.power, 'power');
        setupVoltronPTField(voltronEls.toughness, 'toughness');

        // Keyword dropdown handler
        voltronEls.keywordDropdown.addEventListener('change', (e) => {
            const value = e.target.value;
            if (!value) return;

            const keywordId = voltronKeywordIdCounter++;
            const keyword = {
                id: keywordId,
                type: value,
                value: ''
            };

            voltronState.keywords.push(keyword);
            renderVoltronKeywords();
            voltronEls.keywordDropdown.value = ''; // Reset to "Add keyword..."
        });

        function renderVoltronKeywords() {
            voltronEls.keywordsList.innerHTML = '';

            voltronState.keywords.forEach((keyword) => {
                const badge = document.createElement('div');
                badge.className = 'voltron-keyword-badge';
                badge.dataset.keywordId = keyword.id;

                const icon = document.createElement('span');
                icon.className = 'voltron-keyword-icon';
                icon.textContent = keywordIcons[keyword.type] || '';
                badge.appendChild(icon);

                const text = document.createElement('span');
                text.className = 'voltron-keyword-text';

                if (keyword.type === 'ward' || keyword.type === 'protection') {
                    text.textContent = keywordNames[keyword.type] + ' ';
                    badge.appendChild(text);

                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'voltron-keyword-input';
                    input.placeholder = keyword.type === 'ward' ? 'cost' : 'what?';
                    input.value = keyword.value || '';
                    input.addEventListener('input', (e) => {
                        keyword.value = e.target.value;
                    });
                    input.addEventListener('click', (e) => e.stopPropagation());
                    badge.appendChild(input);
                } else {
                    text.textContent = keywordNames[keyword.type];
                    badge.appendChild(text);
                }

                const removeBtn = document.createElement('button');
                removeBtn.className = 'voltron-keyword-remove';
                removeBtn.textContent = '';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeVoltronKeyword(keyword.id);
                });
                badge.appendChild(removeBtn);

                voltronEls.keywordsList.appendChild(badge);
            });
        }

        function removeVoltronKeyword(id) {
            voltronState.keywords = voltronState.keywords.filter(k => k.id !== id);
            renderVoltronKeywords();
        }

        // Voltron Reset All
        voltronEls.resetAll.addEventListener('click', () => {
            resetVoltronState();
            resetEnchantmentState();
        });

        function resetVoltronState() {
            voltronState.power = 5;
            voltronState.toughness = 5;
            voltronState.keywords = [];
            voltronKeywordIdCounter = 0;
            updateVoltronPower();
            updateVoltronToughness();
            renderVoltronKeywords();
            voltronEls.keywordDropdown.value = '';
            // Remove lethal animation
            const title = document.getElementById('enchantmentTitle');
            if (title) title.classList.remove('lethal');
        }

        function resetEnchantmentState() {
            enchState.commanderTax = 0;
            enchState.field = 0;
            enchState.control = 0;
            enchState.auras = 0;
            updateEnchCommanderTax();
            updateEnchField();
            updateEnchControl();
            updateEnchAuras();
        }

        // Update enchantment Reset All to also reset Voltron
        enchEls.resetAll.removeEventListener('click', enchEls.resetAll._handler);
        enchEls.resetAll._handler = () => {
            resetEnchantmentState();
            resetVoltronState();
        };
        enchEls.resetAll.addEventListener('click', enchEls.resetAll._handler);

        // ========== MODE SWITCHING WITH CONFIRMATION ==========

        // Triple-tap handler to show confirmation modal
        function handleSettingsTripleTap(e) {
            e.stopPropagation();
            settingsTapCount++;
            
            if (settingsTapCount === 3) {
                settingsTapCount = 0;
                clearTimeout(settingsTapTimeout);
                // Show confirmation modal
                voltronEls.modeSwitchModal.classList.add('visible');
            } else {
                clearTimeout(settingsTapTimeout);
                settingsTapTimeout = setTimeout(() => {
                    settingsTapCount = 0;
                }, 500);
            }
        }
        
        // Desktop: use click
        enchEls.settingsPanelTitle.addEventListener('click', handleSettingsTripleTap);
        
        // Mobile: use touchend directly (bypasses the document-level touchend preventDefault)
        enchEls.settingsPanelTitle.addEventListener('touchend', (e) => {
            e.stopPropagation();
            // Prevent the click event from also firing (avoid double-counting)
            e.preventDefault();
            handleSettingsTripleTap(e);
        });

        // Mode switch confirmation
        voltronEls.modeSwitchConfirm.addEventListener('click', () => {
            voltronEls.modeSwitchModal.classList.remove('visible');
            resetAllAppState();
            switchToEnchantmentMode();
        });

        voltronEls.modeSwitchCancel.addEventListener('click', () => {
            voltronEls.modeSwitchModal.classList.remove('visible');
        });

        // Click outside modal to close
        voltronEls.modeSwitchModal.addEventListener('click', (e) => {
            if (e.target === voltronEls.modeSwitchModal) {
                voltronEls.modeSwitchModal.classList.remove('visible');
            }
        });

        // Reset all app state when switching modes
        function resetAllAppState() {
            // Reset coinflip state
            state.commanderTax = 0;
            state.history = [];
            state.stats = {
                wins: 0,
                losses: 0,
                longestWinStreak: 0,
                longestLossStreak: 0,
                currentWinStreak: 0,
                currentLossStreak: 0
            };
            state.undoStack = [];
            state.canUndo = false;
            state.zndrspltTax = 0;
            state.okaunTax = 0;
            state.otherTax = 0;
            
            // Reset Okaun state
            state.okauns = [{
                power: 3n,
                toughness: 3n,
                basePower: 3n,
                baseToughness: 3n,
                plusXActive: false,
                plusXPower: 1n,
                plusXToughness: 1n
            }];
            state.currentOkaunIndex = 0;
            
            // Update UI
            els.resultDisplay.textContent = '';
            els.resultDisplay.classList.remove('win', 'loss');
            renderHistory();
            els.undoFlipBtn.classList.remove('has-undo');
            els.zndrspltNum.textContent = '+0';
            els.okaunTaxNum.textContent = '+0';
            els.otherTaxNum.textContent = '+0';
            
            // Reset enchantment state
            resetEnchantmentState();
            
            // Reset voltron state
            resetVoltronState();
            voltronState.active = false;
            enchEls.container.classList.remove('voltron-active');
            
            // Reset title
            const title = document.getElementById('enchantmentTitle');
            if (title) {
                title.textContent = 'ENCHANTMENT TRACKER';
                title.classList.remove('lethal');
            }
        }

        // Update return to coinflip to also reset
        enchEls.returnBtn.removeEventListener('click', enchEls.returnBtn._handler);
        enchEls.returnBtn._handler = () => {
            resetAllAppState();
            switchToCoinflipMode();
        };
        enchEls.returnBtn.addEventListener('click', enchEls.returnBtn._handler);
    </script>
</body>
</html>
